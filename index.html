<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>大自在山新春祈福法会-太岁灯2026登记</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: system-ui, -apple-system, "PingFang SC","Microsoft YaHei", Arial;
    background-color: #f5f5f5;
    color: #333;
    line-height: 1.6;
    padding: 15px;
  }
  
  .container {
    max-width: 600px;
    margin: 0 auto;
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  
  h1 {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 20px;
    font-size: 24px;
  }
  
  .description {
    background-color: #ecf0f1;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    line-height: 1.8;
    font-size: 14px;
  }
  
  .description p {
    margin-bottom: 10px;
  }
  
  .msg {
    margin: 15px 0;
    padding: 10px;
    border-radius: 4px;
    text-align: center;
    font-size: 14px;
  }
  
  .ok {
    color: #0a7d33;
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
  }
  
  .err {
    color: #b80000;
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
  }
  
  h2 {
    color: #34495e;
    margin-bottom: 15px;
    font-size: 20px;
  }
  
  /* 表单样式 */
  .form-row {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background-color: #fafafa;
  }
  
  .form-row-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  
  .form-row-title {
    font-weight: bold;
    color: #2c3e50;
    font-size: 16px;
  }
  
  .form-group {
    margin-bottom: 15px;
  }
  
  label {
    display: block;
    font-weight: 600;
    margin: 8px 0 4px;
    color: #555;
    font-size: 14px;
  }
  
  input, select {
    font-size: 16px;
    padding: 12px;
    width: 100%;
    box-sizing: border-box;
    border: 1px solid #ddd;
    border-radius: 4px;
    transition: border-color 0.3s;
    background-color: white;
  }
  
  input:focus, select:focus {
    border-color: #3498db;
    outline: none;
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
  }
  
  /* 按钮样式 */
  .btn {
    padding: 12px 20px;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: bold;
  }
  
  .btn-primary {
    background-color: #3498db;
    color: white;
    width: 100%;
  }
  
  .btn-primary:hover {
    background-color: #2980b9;
  }
  
  .btn-secondary {
    background-color: #95a5a6;
    color: white;
    width: 100%;
    margin-bottom: 10px;
  }
  
  .btn-secondary:hover {
    background-color: #7f8c8d;
  }
  
  .btn-success {
    background-color: #2ecc71;
    color: white;
    width: 100%;
  }
  
  .btn-success:hover {
    background-color: #27ae60;
  }
  
  .btn-danger {
    background-color: #e74c3c;
    color: white;
    padding: 8px 15px;
    font-size: 14px;
  }
  
  .btn-danger:hover {
    background-color: #c0392b;
  }
  
  /* 辅助文本 */
  .muted {
    color: #666;
    font-size: 12px;
    margin-top: 5px;
  }
  
  /* 表单操作按钮 */
  .form-actions {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  
  /* 管理链接 */
  .admin-link {
    text-align: center;
    margin-top: 20px;
    font-size: 14px;
  }
  
  .admin-link a {
    color: #3498db;
    text-decoration: none;
  }
  
  .admin-link a:hover {
    text-decoration: underline;
  }
  
  /* 检查数据库按钮 */
  .check-db {
    text-align: center;
    margin-top: 20px;
  }
  
  /* 响应式设计 */
  @media (max-width: 480px) {
    body {
      padding: 10px;
    }
    
    .container {
      padding: 15px;
    }
    
    h1 {
      font-size: 20px;
    }
    
    h2 {
      font-size: 18px;
    }
    
    .btn {
      padding: 10px 16px;
      font-size: 14px;
    }
  }
</style>
</head>
<body>
  <div class="container">
    <h1>大自在山新春祈福法会-太岁灯2026登记</h1>
    
    <div class="description">
      <p>丙午双火年，气火偏盛，人心易躁，情绪多有波动，身体易受病气侵扰，尤以犯太岁、正冲、旁冲者为甚，更宜为自身与大地发心祈福，调和身心，护佑安康。诚邀您于大自在禅寺同沐佛菩萨的光明加持</p>
      <p>【太岁灯】「七天共修，全年专属佛龛点灯。</p>
      <p>以上项目，皆为诸功德主祈求诸佛菩萨加特庇佑，祈福消灾，身心和协安定。</p>
    </div>
    
    <!-- 消息提示 -->
    <div id="msg" class="msg"></div>
    
    <!-- 登记内容 -->
    <h2>登记内容</h2>
    
    <!-- 表单容器 -->
    <div id="formContainer">
      <!-- 表单行会通过JavaScript动态生成 -->
    </div>
    
    <!-- 表单操作按钮 -->
    <div class="form-actions">
      <button class="btn btn-secondary" onclick="addFormRow()">增加一行</button>
      <button class="btn btn-success" onclick="submitForm()">提交登记</button>
    </div>
    
    <!-- 检查数据库按钮 -->
    <div class="check-db">
      <button class="btn btn-primary" onclick="checkDatabase()">检查数据库</button>
    </div>
    
    <!-- 管理页面链接 -->
   // <div class="admin-link">
    //  <a href="admin.html">进入管理页面</a>
   // </div>
  </div>

<script>
const API_BASE = "/api"; // Vercel 默认：/api/xxx
const EXCHANGE_RATE = 4.2; // 新台币:人民币 = 4.2:1
const STORAGE_KEY = "taishui_records_2026"; // 本地存储键名

// 生肖选项
const zodiacOptions = [
  { value: "肖马：值太岁、刑太岁", label: "肖马：值太岁、刑太岁" },
  { value: "肖鼠：冲太岁", label: "肖鼠：冲太岁" },
  { value: "肖兔：破太岁", label: "肖兔：破太岁" },
  { value: "肖牛：害太岁", label: "肖牛：害太岁" },
  { value: "肖鸡：害太岁、刑太岁", label: "肖鸡：害太岁、刑太岁" }
];

// DOM元素
const msgElement = document.getElementById("msg");
const formContainer = document.getElementById("formContainer");

// 设置消息
function setMsg(text, type = "") {
  msgElement.className = "msg " + (type || "");
  msgElement.textContent = text;
}

// 读取本地存储数据
function readLocalData() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  } catch (e) {
    return [];
  }
}

// 写入本地存储数据
function writeLocalData(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

// 创建表单行
function createFormRow(index) {
  const row = document.createElement("div");
  row.className = "form-row";
  row.innerHTML = `
    <div class="form-row-header">
      <div class="form-row-title">登记项 ${index + 1}</div>
      ${index > 0 ? `<button class="btn btn-danger" onclick="deleteFormRow(${index})">删除</button>` : ""}
    </div>
    
    <div class="form-group">
      <label for="name-${index}">一、功德主姓名（祈福者）</label>
      <input type="text" id="name-${index}" placeholder="请输入功德主姓名" required>
    </div>
    
    <div class="form-group">
      <label for="zodiac-${index}">二、2026年（丙午年）需安太岁的生肖</label>
      <select id="zodiac-${index}" required>
        <option value="">请选择生肖</option>
        ${zodiacOptions.map(option => `<option value="${option.value}">${option.label}</option>`).join("")}
      </select>
    </div>
    
    <div class="form-group">
      <label for="amountNTD-${index}">三、护持金额（新台币）</label>
      <input type="number" id="amountNTD-${index}" value="1200" min="0" step="1" required>
      <div class="muted">人民币：<span id="amountCNY-${index}">${Math.round(1200 / EXCHANGE_RATE)}</span> 元（汇率：1:${EXCHANGE_RATE}）</div>
    </div>
    
    <div class="form-group">
      <label for="contact-${index}">四、联系人（缴费）</label>
      <input type="text" id="contact-${index}" placeholder="请输入联系人姓名" required>
    </div>
  `;
  
  return row;
}

// 初始化表单
function initForm() {
  // 清空表单容器
  formContainer.innerHTML = "";
  
  // 添加一行表单
  addFormRow();
}

// 添加表单行
function addFormRow() {
  const currentRows = formContainer.children.length;
  const newRow = createFormRow(currentRows);
  formContainer.appendChild(newRow);
  
  // 添加金额变化监听器
  const amountNTDInput = newRow.querySelector(`#amountNTD-${currentRows}`);
  const amountCNYDisplay = newRow.querySelector(`#amountCNY-${currentRows}`);
  
  amountNTDInput.addEventListener("input", function() {
    const ntdAmount = parseFloat(this.value) || 0;
    const cnyAmount = Math.round(ntdAmount / EXCHANGE_RATE);
    amountCNYDisplay.textContent = cnyAmount;
  });
}

// 删除表单行
function deleteFormRow(index) {
  if (formContainer.children.length > 1) {
    formContainer.removeChild(formContainer.children[index]);
    
    // 重新编号表单行
    Array.from(formContainer.children).forEach((row, i) => {
      const titleElement = row.querySelector(".form-row-title");
      if (titleElement) {
        titleElement.textContent = `登记项 ${i + 1}`;
      }
      
      // 更新删除按钮的索引
      const deleteBtn = row.querySelector(".btn-danger");
      if (deleteBtn) {
        deleteBtn.onclick = function() { deleteFormRow(i); };
      }
    });
  } else {
    setMsg("至少需要保留一行表单", "err");
  }
}

// 收集表单数据
function collectFormData() {
  const rows = [];
  let isValid = true;
  
  Array.from(formContainer.children).forEach((row, index) => {
    const name = row.querySelector(`#name-${index}`).value.trim();
    const zodiac = row.querySelector(`#zodiac-${index}`).value;
    const amountNTD = parseFloat(row.querySelector(`#amountNTD-${index}`).value) || 0;
    const amountCNY = Math.round(amountNTD / EXCHANGE_RATE);
    const contact = row.querySelector(`#contact-${index}`).value.trim();
    
    // 验证必填项
    if (!name || !zodiac || !contact) {
      isValid = false;
      return;
    }
    
    rows.push({
      name,
      zodiac,
      amountNTD,
      amountCNY,
      contact
    });
  });
  
  if (!isValid) {
    setMsg("请填写所有必填项", "err");
    return null;
  }
  
  return rows;
}

// 提交表单
async function submitForm() {
  const formData = collectFormData();
  if (!formData) return;
  
  setMsg("提交中...");
  
  try {
    // 保存到本地存储
    const localData = readLocalData();
    localData.push(...formData);
    writeLocalData(localData);
    
    // 提交到Notion
    for (const row of formData) {
      const resp = await fetch(API_BASE + "/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          title: row.name,
          zodiac: row.zodiac,
          "护持金额台币": row.amountNTD,
          人民币: row.amountCNY,
          联系人: row.contact
        })
      });
      
      const result = await resp.json();
      if (!resp.ok) {
        throw new Error(result.error || resp.statusText);
      }
    }
    
    // 清空表单
    initForm();
    
    setMsg("登记成功！数据已保存到Notion数据库。", "ok");
  } catch (e) {
    setMsg("提交失败：" + String(e), "err");
    console.error("提交失败：", e);
  }
}

// 检查数据库连接
async function checkDatabase() {
  setMsg("检查中...");
  
  try {
    const resp = await fetch(API_BASE + "/health");
    const data = await resp.json();
    
    if (resp.ok && data.ok) {
      setMsg("数据库连接正常！", "ok");
    } else {
      setMsg("数据库连接失败：" + (data.error || resp.statusText), "err");
    }
  } catch (e) {
    setMsg("检查失败：" + String(e), "err");
    console.error("检查失败：", e);
  }
}

// 初始化
function init() {
  // 初始化表单
  initForm();
}

// 页面加载完成后初始化
window.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
