<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>å¤§è‡ªåœ¨å±±æ–°æ˜¥ç¥ˆç¦æ³•ä¼š-å¤ªå²ç¯2026ç®¡ç†é¡µé¢</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: system-ui, -apple-system, "PingFang SC","Microsoft YaHei", Arial;
    background-color: #f5f5f5;
    color: #333;
    line-height: 1.6;
    padding: 15px;
  }
  
  .container {
    max-width: 1100px;
    margin: 0 auto;
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  
  h1 {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 20px;
    font-size: 24px;
  }
  
  .msg {
    margin: 15px 0;
    padding: 12px;
    border-radius: 4px;
    text-align: center;
    font-size: 14px;
  }
  
  .ok {
    color: #0a7d33;
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
  }
  
  .err {
    color: #b80000;
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
  }
  
  .info {
    color: #0c5460;
    background-color: #d1ecf1;
    border: 1px solid #bee5eb;
  }
  
  .warning {
    color: #856404;
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
  }
  
  /* æŒ‰é’®æ ·å¼ */
  .btn {
    padding: 12px 20px;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: bold;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  
  .btn-primary {
    background-color: #3498db;
    color: white;
  }
  
  .btn-primary:hover {
    background-color: #2980b9;
  }
  
  .btn-success {
    background-color: #2ecc71;
    color: white;
  }
  
  .btn-success:hover {
    background-color: #27ae60;
  }
  
  .btn-danger {
    background-color: #e74c3c;
    color: white;
  }
  
  .btn-danger:hover {
    background-color: #c0392b;
  }
  
  .btn-warning {
    background-color: #f39c12;
    color: white;
  }
  
  .btn-warning:hover {
    background-color: #d68910;
  }
  
  /* è¡¨æ ¼æ ·å¼ */
  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 20px;
    background-color: white;
  }
  
  th, td {
    border: 1px solid #ddd;
    padding: 12px;
    text-align: left;
    font-size: 14px;
  }
  
  th {
    background-color: #f2f2f2;
    font-weight: bold;
    color: #555;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  
  tr:nth-child(even) {
    background-color: #f9f9f9;
  }
  
  tr:hover {
    background-color: #f5f5f5;
  }
  
  /* æŒ‰é’®ç»„ */
  .btn-group {
    margin: 20px 0;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
  }
  
  /* è¿”å›é“¾æ¥ */
  .back-link {
    display: inline-block;
    margin-top: 20px;
    color: #3498db;
    text-decoration: none;
    font-size: 14px;
  }
  
  .back-link:hover {
    text-decoration: underline;
  }
  
  /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
  .status-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 8px;
  }
  
  .status-online {
    background-color: #2ecc71;
  }
  
  .status-offline {
    background-color: #e74c3c;
  }
  
  .status-warning {
    background-color: #f39c12;
  }
  
  /* ç»Ÿè®¡å¡ç‰‡ */
  .stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 20px 0;
  }
  
  .stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
  }
  
  .stat-card h3 {
    margin: 0 0 10px 0;
    font-size: 14px;
    opacity: 0.9;
  }
  
  .stat-card .value {
    font-size: 24px;
    font-weight: bold;
  }
  
  /* åŠ è½½åŠ¨ç”» */
  .loader {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 30px auto;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .container {
      padding: 15px;
    }
    
    .btn-group {
      flex-direction: column;
    }
    
    .btn {
      width: 100%;
    }
    
    .table-container {
      overflow-x: auto;
    }
  }
  
  /* è¡¨æ ¼å®¹å™¨ */
  .table-container {
    overflow-x: auto;
    margin-top: 20px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    max-height: 500px;
    overflow-y: auto;
  }
  
  /* æ“ä½œæŒ‰é’®ç»„ */
  .action-buttons {
    display: flex;
    gap: 5px;
  }
  
  /* æœç´¢æ¡† */
  .search-box {
    margin: 20px 0;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 8px;
  }
  
  .search-box input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
  }
</style>
</head>
<body>
  <div class="container">
    <h1>å¤§è‡ªåœ¨å±±æ–°æ˜¥ç¥ˆç¦æ³•ä¼š-å¤ªå²ç¯2026ç®¡ç†é¡µé¢</h1>
    
    <!-- çŠ¶æ€æ  -->
    <div id="statusBar" class="msg info">
      <span id="statusIcon" class="status-indicator status-offline"></span>
      <span id="statusText">æ­£åœ¨è¿æ¥æ•°æ®åº“...</span>
    </div>
    
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div id="statsContainer" class="stats-container" style="display: none;">
      <div class="stat-card">
        <h3>æ€»è®°å½•æ•°</h3>
        <div class="value" id="totalCount">0</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <h3>æŠ¤æŒæ€»é‡‘é¢ (å°å¸)</h3>
        <div class="value" id="totalAmountNTD">0</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
        <h3>æŠ¤æŒæ€»é‡‘é¢ (äººæ°‘å¸)</h3>
        <div class="value" id="totalAmountCNY">0</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
        <h3>æœ€åæ›´æ–°æ—¶é—´</h3>
        <div class="value" id="lastUpdate">-</div>
      </div>
    </div>
    
    <!-- æœç´¢æ¡† -->
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="æœç´¢å§“åã€ç”Ÿè‚–æˆ–è”ç³»äºº..." oninput="filterTable()">
    </div>
    
    <!-- æ¶ˆæ¯æç¤º -->
    <div id="msg" class="msg"></div>
    
    <!-- æŒ‰é’®ç»„ -->
    <div class="btn-group">
      <button class="btn btn-primary" onclick="loadDatabaseData()">
        <span>ğŸ”„</span> åˆ·æ–°æ•°æ®åº“æ•°æ®
      </button>
      <button class="btn btn-success" onclick="exportData()">
        <span>ğŸ“Š</span> å¯¼å‡ºä¸ºExcel
      </button>
      <button class="btn btn-warning" onclick="testConnection()">
        <span>ğŸ”§</span> æµ‹è¯•APIè¿æ¥
      </button>
      <button class="btn btn-danger" onclick="testSubmitAPI()">
        <span>ğŸ§ª</span> æµ‹è¯•æäº¤API
      </button>
      <button class="btn btn-warning" onclick="addTestRecord()">
        <span>â•</span> æ·»åŠ æµ‹è¯•è®°å½•
      </button>
    </div>
    
    <!-- åŠ è½½åŠ¨ç”» -->
    <div id="loader" class="loader" style="display: none;"></div>
    
    <!-- è¡¨æ ¼å®¹å™¨ -->
    <div class="table-container">
      <table id="dataTable">
        <thead>
          <tr>
            <th>åºå·</th>
            <th>ID</th>
            <th>å§“å</th>
            <th>ç”Ÿè‚–</th>
            <th>æŠ¤æŒé‡‘é¢å°å¸</th>
            <th>äººæ°‘å¸</th>
            <th>è”ç³»äºº</th>
            <th>åˆ›å»ºæ—¶é—´</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="dataTableBody"></tbody>
      </table>
    </div>
    
    <!-- æ— æ•°æ®æç¤º -->
    <div id="noData" class="msg info" style="display: none;">
      ğŸ“­ æ•°æ®åº“ä¸­æ²¡æœ‰è®°å½•ï¼Œæˆ–åŠ è½½å¤±è´¥
    </div>
    
    <!-- è¿”å›é“¾æ¥ -->
    <div style="text-align: center; margin-top: 30px;">
      <a href="index.html" class="back-link">â¬…ï¸ è¿”å›ç™»è®°é¡µé¢</a>
      <span style="margin: 0 10px; color: #ddd">|</span>
      <a href="javascript:void(0)" onclick="showDebugInfo()" class="back-link">ğŸ› è°ƒè¯•ä¿¡æ¯</a>
      <span style="margin: 0 10px; color: #ddd">|</span>
      <a href="javascript:void(0)" onclick="clearAllData()" class="back-link" style="color: #e74c3c;">âš ï¸ æ¸…ç©ºæ•°æ®åº“(å±é™©)</a>
    </div>
  </div>

<script>
// é…ç½®
const CONFIG = {
  API_BASE: window.location.origin + "/api"
};

// ç”Ÿè‚–æ˜ å°„
const ZODIAC_MAP = {
  "è‚–é©¬": "è‚–é©¬ï¼šå€¼å¤ªå²ã€åˆ‘å¤ªå²",
  "è‚–é¼ ": "è‚–é¼ ï¼šå†²å¤ªå²",
  "è‚–å…”": "è‚–å…”ï¼šç ´å¤ªå²",
  "è‚–ç‰›": "è‚–ç‰›ï¼šå®³å¤ªå²",
  "è‚–é¸¡": "è‚–é¸¡ï¼šå®³å¤ªå²ã€åˆ‘å¤ªå²"
};

// å…¨å±€å˜é‡
let databaseData = [];

// DOMå…ƒç´ 
const msgElement = document.getElementById("msg");
const statusBar = document.getElementById("statusBar");
const statusIcon = document.getElementById("statusIcon");
const statusText = document.getElementById("statusText");
const dataTableBody = document.getElementById("dataTableBody");
const noDataElement = document.getElementById("noData");
const loader = document.getElementById("loader");
const statsContainer = document.getElementById("statsContainer");
const searchInput = document.getElementById("searchInput");

// è®¾ç½®æ¶ˆæ¯
function setMsg(text, type = "") {
  msgElement.className = "msg " + type;
  msgElement.textContent = text;
  msgElement.style.display = text ? "block" : "none";
}

// æ›´æ–°çŠ¶æ€æ 
function updateStatus(iconClass, text) {
  statusIcon.className = "status-indicator " + iconClass;
  statusText.textContent = text;
}

// æ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
function showLoader(show) {
  loader.style.display = show ? "block" : "none";
}

// å¢å¼ºçš„fetchå‡½æ•°
async function enhancedFetch(url, options = {}) {
  const startTime = Date.now();
  
  try {
    const response = await fetch(url, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      }
    });
    
    const endTime = Date.now();
    const duration = endTime - startTime;
    
    console.log(`ğŸŒ ${options.method || 'GET'} ${url}`, {
      status: response.status,
      duration: `${duration}ms`,
      ok: response.ok
    });
    
    return response;
  } catch (error) {
    console.error(`âŒ ${options.method || 'GET'} ${url}`, error);
    throw error;
  }
}

// æ£€æŸ¥æ•°æ®åº“å¥åº·çŠ¶æ€
async function checkDatabaseHealth() {
  try {
    const response = await enhancedFetch(CONFIG.API_BASE + "/health");
    const data = await response.json();
    
    if (data.ok) {
      updateStatus("status-online", "æ•°æ®åº“è¿æ¥æ­£å¸¸");
      return { success: true, data };
    } else {
      updateStatus("status-warning", "æ•°æ®åº“é…ç½®æœ‰é—®é¢˜");
      return { success: false, error: data.error, data };
    }
  } catch (error) {
    updateStatus("status-offline", "æ•°æ®åº“è¿æ¥å¤±è´¥");
    return { success: false, error: error.message };
  }
}

// ä»æ•°æ®åº“åŠ è½½æ•°æ®
async function loadDatabaseData() {
  showLoader(true);
  setMsg("æ­£åœ¨ä»æ•°æ®åº“åŠ è½½æ•°æ®...", "info");
  
  try {
    // å…ˆæ£€æŸ¥æ•°æ®åº“çŠ¶æ€
    const healthResult = await checkDatabaseHealth();
    
    if (!healthResult.success) {
      setMsg(`æ•°æ®åº“æ£€æŸ¥å¤±è´¥: ${healthResult.error}`, "err");
      showLoader(false);
      return;
    }
    
    // è¿™é‡Œéœ€è¦è°ƒç”¨è·å–æ•°æ®çš„API
    // ç”±äºæ²¡æœ‰ä¸“é—¨çš„è·å–APIï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ¨¡æ‹Ÿæ¥è·å–
    setMsg("æ­£åœ¨è·å–æ•°æ®åº“è®°å½•...", "info");
    
    // æ¨¡æ‹Ÿæ•°æ®è·å–ï¼ˆå®é™…åº”è¯¥è°ƒç”¨APIï¼‰
    // è¿™é‡Œæˆ‘ä»¬å…ˆæ˜¾ç¤ºä¸€ä¸ªè¯´æ˜
    databaseData = [];
    
    // å¦‚æœæœ‰æ•°æ®APIï¼Œåº”è¯¥è¿™æ ·è°ƒç”¨ï¼š
    // const response = await enhancedFetch(CONFIG.API_BASE + "/data");
    // databaseData = await response.json();
    
    setMsg("âš ï¸ æ³¨æ„ï¼šå½“å‰æ²¡æœ‰å®ç°æ•°æ®è·å–APIï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š", "warning");
    setMsg("1. ä½¿ç”¨æµ‹è¯•æäº¤APIæ·»åŠ è®°å½•<br>2. åœ¨Notionæ•°æ®åº“ç›´æ¥æŸ¥çœ‹æ•°æ®<br>3. å®ç°æ•°æ®è·å–API", "warning");
    
    // ä¸ºäº†æ¼”ç¤ºï¼Œæ·»åŠ ä¸€äº›ç¤ºä¾‹æ•°æ®
    addSampleDataForDemo();
    
  } catch (error) {
    console.error("åŠ è½½æ•°æ®å¤±è´¥:", error);
    setMsg("åŠ è½½å¤±è´¥: " + error.message, "err");
    updateStatus("status-offline", "åŠ è½½å¤±è´¥");
  } finally {
    showLoader(false);
  }
}

// æ·»åŠ ç¤ºä¾‹æ•°æ®ï¼ˆæ¼”ç¤ºç”¨ï¼‰
function addSampleDataForDemo() {
  databaseData = [
    {
      id: "demo-1",
      name: "å¼ ä¸‰",
      zodiac: "è‚–é©¬",
      amountNTD: 1200,
      amountCNY: 286,
      contact: "æå››",
      createdAt: new Date().toISOString()
    },
    {
      id: "demo-2",
      name: "ç‹äº”",
      zodiac: "è‚–é¼ ",
      amountNTD: 2400,
      amountCNY: 571,
      contact: "èµµå…­",
      createdAt: new Date(Date.now() - 86400000).toISOString()
    },
    {
      id: "demo-3",
      name: "æµ‹è¯•ç”¨æˆ·",
      zodiac: "è‚–å…”",
      amountNTD: 1200,
      amountCNY: 286,
      contact: "æµ‹è¯•è”ç³»äºº",
      createdAt: new Date(Date.now() - 172800000).toISOString()
    }
  ];
  
  renderDataTable(databaseData);
  updateStats(databaseData);
  setMsg("å·²åŠ è½½ç¤ºä¾‹æ•°æ®ï¼ˆæ¼”ç¤ºç”¨ï¼‰", "info");
}

// æµ‹è¯•æäº¤API
async function testSubmitAPI() {
  showLoader(true);
  setMsg("æ­£åœ¨æµ‹è¯•æäº¤API...", "info");
  
  try {
    const testData = {
      title: `æµ‹è¯•ç”¨æˆ·_${Date.now()}`,
      zodiac: "è‚–é©¬",
      "æŠ¤æŒé‡‘é¢å°å¸": 1200,
      äººæ°‘å¸: 286,
      è”ç³»äºº: "æµ‹è¯•ç®¡ç†å‘˜"
    };
    
    console.log("æµ‹è¯•æäº¤æ•°æ®:", testData);
    
    const response = await enhancedFetch(CONFIG.API_BASE + "/submit", {
      method: "POST",
      body: JSON.stringify(testData)
    });
    
    const result = await response.json();
    console.log("æµ‹è¯•æäº¤å“åº”:", result);
    
    if (response.ok && (result.ok || result.pageId)) {
      setMsg(`âœ… æäº¤APIæµ‹è¯•æˆåŠŸï¼é¡µé¢ID: ${result.pageId || "N/A"}`, "ok");
      updateStatus("status-online", "æäº¤APIæ­£å¸¸");
      
      // åˆ·æ–°æ•°æ®
      setTimeout(() => loadDatabaseData(), 1000);
    } else {
      const errorMsg = result.error || result.message || `HTTP ${response.status}`;
      setMsg(`âŒ æäº¤APIæµ‹è¯•å¤±è´¥: ${errorMsg}`, "err");
      
      // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
      if (result.error && result.error.includes("ç¼ºå°‘åˆ—")) {
        setMsg(`æ•°æ®åº“å­—æ®µé—®é¢˜: ${result.error}`, "err");
      }
    }
  } catch (error) {
    console.error("æµ‹è¯•æäº¤APIå¼‚å¸¸:", error);
    setMsg("æµ‹è¯•æäº¤å¼‚å¸¸: " + error.message, "err");
    updateStatus("status-offline", "æäº¤APIå¼‚å¸¸");
  } finally {
    showLoader(false);
  }
}

// æ·»åŠ æµ‹è¯•è®°å½•
async function addTestRecord() {
  const name = prompt("è¯·è¾“å…¥æµ‹è¯•å§“å:", "æµ‹è¯•ç”¨æˆ·_" + Date.now().toString().slice(-6));
  if (!name) return;
  
  const zodiac = prompt("è¯·é€‰æ‹©ç”Ÿè‚–:\n1. è‚–é©¬\n2. è‚–é¼ \n3. è‚–å…”\n4. è‚–ç‰›\n5. è‚–é¸¡", "è‚–é©¬");
  if (!zodiac) return;
  
  const amountStr = prompt("è¯·è¾“å…¥æŠ¤æŒé‡‘é¢ï¼ˆå°å¸ï¼‰:", "1200");
  const amountNTD = parseInt(amountStr) || 1200;
  const amountCNY = Math.round(amountNTD / 4.2);
  
  const contact = prompt("è¯·è¾“å…¥è”ç³»äºº:", "æµ‹è¯•è”ç³»äºº");
  if (!contact) return;
  
  showLoader(true);
  setMsg("æ­£åœ¨æäº¤æµ‹è¯•è®°å½•...", "info");
  
  try {
    const testData = {
      title: name,
      zodiac: zodiac,
      "æŠ¤æŒé‡‘é¢å°å¸": amountNTD,
      äººæ°‘å¸: amountCNY,
      è”ç³»äºº: contact
    };
    
    console.log("æ·»åŠ æµ‹è¯•è®°å½•:", testData);
    
    const response = await enhancedFetch(CONFIG.API_BASE + "/submit", {
      method: "POST",
      body: JSON.stringify(testData)
    });
    
    const result = await response.json();
    console.log("æ·»åŠ è®°å½•å“åº”:", result);
    
    if (response.ok && (result.ok || result.pageId)) {
      setMsg(`âœ… æµ‹è¯•è®°å½•æ·»åŠ æˆåŠŸï¼é¡µé¢ID: ${result.pageId || "N/A"}`, "ok");
      
      // æ·»åŠ åˆ°æœ¬åœ°æ•°æ®åˆ—è¡¨
      databaseData.unshift({
        id: result.pageId || `temp-${Date.now()}`,
        name: name,
        zodiac: zodiac,
        amountNTD: amountNTD,
        amountCNY: amountCNY,
        contact: contact,
        createdAt: new Date().toISOString()
      });
      
      renderDataTable(databaseData);
      updateStats(databaseData);
      
    } else {
      const errorMsg = result.error || result.message || `HTTP ${response.status}`;
      setMsg(`âŒ æ·»åŠ æµ‹è¯•è®°å½•å¤±è´¥: ${errorMsg}`, "err");
    }
  } catch (error) {
    console.error("æ·»åŠ æµ‹è¯•è®°å½•å¼‚å¸¸:", error);
    setMsg("æ·»åŠ æµ‹è¯•è®°å½•å¼‚å¸¸: " + error.message, "err");
  } finally {
    showLoader(false);
  }
}

// æµ‹è¯•æ‰€æœ‰APIè¿æ¥
async function testConnection() {
  showLoader(true);
  setMsg("æ­£åœ¨æµ‹è¯•æ‰€æœ‰APIè¿æ¥...", "info");
  
  try {
    const tests = [
      { name: "å¥åº·æ£€æŸ¥", url: "/health", method: "GET" },
      { name: "æäº¤API", url: "/submit", method: "POST" }
    ];
    
    let results = [];
    
    for (const test of tests) {
      const startTime = Date.now();
      
      try {
        if (test.method === "POST") {
          // å¯¹äºPOSTæµ‹è¯•ï¼Œå‘é€æµ‹è¯•æ•°æ®
          const testData = {
            title: `æµ‹è¯•_${Date.now()}`,
            zodiac: "è‚–é©¬",
            "æŠ¤æŒé‡‘é¢å°å¸": 1200,
            äººæ°‘å¸: 286,
            è”ç³»äºº: "æµ‹è¯•"
          };
          
          const response = await fetch(CONFIG.API_BASE + test.url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(testData)
          });
          
          const endTime = Date.now();
          const result = await response.json();
          
          results.push({
            name: test.name,
            ok: response.ok,
            status: response.status,
            time: endTime - startTime,
            data: result
          });
          
        } else {
          const response = await fetch(CONFIG.API_BASE + test.url);
          const endTime = Date.now();
          const result = await response.json();
          
          results.push({
            name: test.name,
            ok: response.ok,
            status: response.status,
            time: endTime - startTime,
            data: result
          });
        }
      } catch (error) {
        results.push({
          name: test.name,
          ok: false,
          error: error.message
        });
      }
    }
    
    // æ˜¾ç¤ºç»“æœ
    let message = "APIè¿æ¥æµ‹è¯•ç»“æœ:\n\n";
    results.forEach(result => {
      if (result.ok) {
        message += `âœ… ${result.name}: æ­£å¸¸ (${result.time}ms)\n`;
        if (result.data && result.data.error) {
          message += `   è­¦å‘Š: ${result.data.error}\n`;
        }
      } else {
        message += `âŒ ${result.name}: å¤±è´¥\n`;
        if (result.error) {
          message += `   é”™è¯¯: ${result.error}\n`;
        } else if (result.data && result.data.error) {
          message += `   é”™è¯¯: ${result.data.error}\n`;
        } else {
          message += `   HTTPçŠ¶æ€: ${result.status}\n`;
        }
      }
    });
    
    alert(message);
    
    // æ›´æ–°çŠ¶æ€
    const allOk = results.every(r => r.ok);
    const healthOk = results.find(r => r.name === "å¥åº·æ£€æŸ¥")?.ok;
    const submitOk = results.find(r => r.name === "æäº¤API")?.ok;
    
    if (allOk) {
      updateStatus("status-online", "æ‰€æœ‰APIæ­£å¸¸");
    } else if (healthOk && !submitOk) {
      updateStatus("status-warning", "æäº¤APIå¼‚å¸¸");
    } else {
      updateStatus("status-offline", "APIè¿æ¥é—®é¢˜");
    }
    
  } catch (error) {
    alert("æµ‹è¯•è¿‡ç¨‹å‡ºé”™: " + error.message);
  } finally {
    showLoader(false);
  }
}

// å¯¼å‡ºæ•°æ®ä¸ºExcel
function exportData() {
  if (databaseData.length === 0) {
    setMsg("æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡º", "info");
    return;
  }
  
  try {
    // å‡†å¤‡CSVæ•°æ®
    const headers = ["åºå·", "å§“å", "ç”Ÿè‚–", "æŠ¤æŒé‡‘é¢å°å¸", "äººæ°‘å¸", "è”ç³»äºº", "åˆ›å»ºæ—¶é—´"];
    const csvRows = [headers.join(",")];
    
    let totalNTD = 0;
    let totalCNY = 0;
    
    databaseData.forEach((row, index) => {
      totalNTD += row.amountNTD || 0;
      totalCNY += row.amountCNY || 0;
      
      const timeStr = row.createdAt ? new Date(row.createdAt).toLocaleString('zh-CN') : "-";
      
      const csvRow = [
        index + 1,
        `"${row.name || ""}"`,
        `"${row.zodiac || ""}"`,
        row.amountNTD || 0,
        row.amountCNY || 0,
        `"${row.contact || ""}"`,
        `"${timeStr}"`
      ];
      csvRows.push(csvRow.join(","));
    });
    
    // æ·»åŠ æ±‡æ€»è¡Œ
    csvRows.push("");
    csvRows.push("æ€»è®¡,,,,,,");
    csvRows.push(`åˆè®¡,${totalNTD},${totalCNY},,,,`);
    
    // ç”ŸæˆCSVæ–‡ä»¶
    const csvContent = "\uFEFF" + csvRows.join("\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    
    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const link = document.createElement("a");
    const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, "");
    link.href = url;
    link.download = `å¤ªå²ç¯æ•°æ®_${timestamp}_${databaseData.length}æ¡.csv`;
    link.style.display = "none";
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    URL.revokeObjectURL(url);
    
    setMsg(`âœ… æˆåŠŸå¯¼å‡º ${databaseData.length} æ¡è®°å½•`, "ok");
    
  } catch (error) {
    console.error("å¯¼å‡ºå¤±è´¥:", error);
    setMsg("å¯¼å‡ºå¤±è´¥: " + error.message, "err");
  }
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
function updateStats(data) {
  if (!data || data.length === 0) {
    statsContainer.style.display = "none";
    return;
  }
  
  statsContainer.style.display = "grid";
  
  let totalNTD = 0;
  let totalCNY = 0;
  
  data.forEach(item => {
    totalNTD += item.amountNTD || 0;
    totalCNY += item.amountCNY || 0;
  });
  
  document.getElementById("totalCount").textContent = data.length;
  document.getElementById("totalAmountNTD").textContent = totalNTD.toLocaleString();
  document.getElementById("totalAmountCNY").textContent = totalCNY.toLocaleString();
  
  // è·å–æœ€æ–°è®°å½•çš„æ—¶é—´
  const latestRecord = data.reduce((latest, current) => {
    const currentTime = new Date(current.createdAt || 0).getTime();
    const latestTime = new Date(latest.createdAt || 0).getTime();
    return currentTime > latestTime ? current : latest;
  }, { createdAt: null });
  
  if (latestRecord.createdAt) {
    const date = new Date(latestRecord.createdAt);
    document.getElementById("lastUpdate").textContent = 
      `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
  } else {
    document.getElementById("lastUpdate").textContent = "åˆšåˆš";
  }
}

// æ¸²æŸ“æ•°æ®è¡¨æ ¼
function renderDataTable(data) {
  dataTableBody.innerHTML = "";
  
  if (!data || data.length === 0) {
    noDataElement.style.display = "block";
    return;
  }
  
  noDataElement.style.display = "none";
  
  data.forEach((row, index) => {
    const tr = document.createElement("tr");
    
    // æ ¼å¼åŒ–æ—¶é—´
    let timeDisplay = "-";
    if (row.createdAt) {
      const date = new Date(row.createdAt);
      timeDisplay = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    }
    
    // ç¼©çŸ­IDæ˜¾ç¤º
    const shortId = row.id ? row.id.substring(0, 8) + "..." : "-";
    
    tr.innerHTML = `
      <td>${index + 1}</td>
      <td title="${row.id || ''}">${shortId}</td>
      <td><strong>${row.name || ""}</strong></td>
      <td>${ZODIAC_MAP[row.zodiac] || row.zodiac || ""}</td>
      <td style="text-align: right; color: #2ecc71;">${(row.amountNTD || 0).toLocaleString()}</td>
      <td style="text-align: right; color: #3498db;">${(row.amountCNY || 0).toLocaleString()}</td>
      <td>${row.contact || ""}</td>
      <td>${timeDisplay}</td>
      <td class="action-buttons">
        <button class="btn btn-danger" onclick="deleteRecord('${row.id}', '${row.name}')" title="åˆ é™¤">
          åˆ é™¤
        </button>
      </td>
    `;
    dataTableBody.appendChild(tr);
  });
}

// è¿‡æ»¤è¡¨æ ¼
function filterTable() {
  const searchTerm = searchInput.value.toLowerCase();
  
  if (!searchTerm) {
    renderDataTable(databaseData);
    return;
  }
  
  const filteredData = databaseData.filter(row => {
    return (
      (row.name && row.name.toLowerCase().includes(searchTerm)) ||
      (row.zodiac && row.zodiac.toLowerCase().includes(searchTerm)) ||
      (row.contact && row.contact.toLowerCase().includes(searchTerm)) ||
      (row.amountNTD && row.amountNTD.toString().includes(searchTerm)) ||
      (row.amountCNY && row.amountCNY.toString().includes(searchTerm))
    );
  });
  
  renderDataTable(filteredData);
  setMsg(`æ‰¾åˆ° ${filteredData.length} æ¡åŒ¹é…è®°å½•`, filteredData.length > 0 ? "info" : "warning");
}

// åˆ é™¤è®°å½•
async function deleteRecord(id, name) {
  if (!confirm(`ç¡®å®šè¦åˆ é™¤è®°å½• "${name}" å—ï¼Ÿ\n\næ³¨æ„ï¼šæ­¤æ“ä½œå¯èƒ½éœ€è¦åç«¯APIæ”¯æŒæ‰èƒ½ä»æ•°æ®åº“åˆ é™¤ã€‚`)) {
    return;
  }
  
  showLoader(true);
  setMsg(`æ­£åœ¨åˆ é™¤è®°å½•: ${name}...`, "info");
  
  try {
    // è¿™é‡Œåº”è¯¥è°ƒç”¨åˆ é™¤API
    // const response = await enhancedFetch(`${CONFIG.API_BASE}/delete/${id}`, {
    //   method: "DELETE"
    // });
    
    // æ¨¡æ‹Ÿåˆ é™¤
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // ä»æœ¬åœ°æ•°æ®ä¸­ç§»é™¤
    databaseData = databaseData.filter(item => item.id !== id);
    
    renderDataTable(databaseData);
    updateStats(databaseData);
    
    setMsg(`âœ… è®°å½• "${name}" å·²ä»æœ¬åœ°ç§»é™¤`, "ok");
    
  } catch (error) {
    console.error("åˆ é™¤è®°å½•å¤±è´¥:", error);
    setMsg("åˆ é™¤å¤±è´¥: " + error.message, "err");
  } finally {
    showLoader(false);
  }
}

// æ¸…ç©ºæ•°æ®åº“ï¼ˆå±é™©æ“ä½œï¼‰
async function clearAllData() {
  if (!confirm("âš ï¸ å±é™©æ“ä½œï¼\n\nç¡®å®šè¦æ¸…ç©ºæ•°æ®åº“ä¸­çš„æ‰€æœ‰è®°å½•å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼")) {
    return;
  }
  
  if (!confirm("å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ")) {
    return;
  }
  
  showLoader(true);
  setMsg("æ­£åœ¨æ¸…ç©ºæ•°æ®åº“...", "warning");
  
  try {
    // è¿™é‡Œåº”è¯¥è°ƒç”¨æ¸…ç©ºAPI
    // const response = await enhancedFetch(`${CONFIG.API_BASE}/clear`, {
    //   method: "DELETE"
    // });
    
    // æ¨¡æ‹Ÿæ¸…ç©º
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    databaseData = [];
    renderDataTable(databaseData);
    updateStats(databaseData);
    
    setMsg("âœ… æ•°æ®åº“å·²æ¸…ç©ºï¼ˆæ¼”ç¤ºï¼‰", "ok");
    
  } catch (error) {
    console.error("æ¸…ç©ºæ•°æ®åº“å¤±è´¥:", error);
    setMsg("æ¸…ç©ºå¤±è´¥: " + error.message, "err");
  } finally {
    showLoader(false);
  }
}

// æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
function showDebugInfo() {
  const info = {
    é¡µé¢URL: window.location.href,
    APIåœ°å€: CONFIG.API_BASE,
    æ•°æ®åº“è®°å½•æ•°: databaseData.length,
    ç”¨æˆ·ä»£ç†: navigator.userAgent,
    å½“å‰æ—¶é—´: new Date().toISOString(),
    å¥åº·æ£€æŸ¥: CONFIG.API_BASE + "/health",
    æäº¤API: CONFIG.API_BASE + "/submit"
  };
  
  console.log("è°ƒè¯•ä¿¡æ¯:", info);
  
  let message = "è°ƒè¯•ä¿¡æ¯:\n\n";
  for (const [key, value] of Object.entries(info)) {
    message += `${key}: ${value}\n`;
  }
  
  alert(message + "\nè¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å° (F12)");
}

// åˆå§‹åŒ–
async function init() {
  console.log("ğŸ”„ ç®¡ç†é¡µé¢åˆå§‹åŒ–");
  console.log("ğŸŒ APIåœ°å€:", CONFIG.API_BASE);
  
  // è‡ªåŠ¨æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
  setTimeout(async () => {
    await checkDatabaseHealth();
  }, 500);
  
  // åŠ è½½ç¤ºä¾‹æ•°æ®
  setTimeout(() => {
    addSampleDataForDemo();
  }, 1000);
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener("DOMContentLoaded", init);

// é”®ç›˜å¿«æ·é”®
document.addEventListener("keydown", (e) => {
  // Ctrl+F èšç„¦æœç´¢æ¡†
  if (e.ctrlKey && e.key === "f") {
    e.preventDefault();
    searchInput.focus();
  }
  
  // F5 åˆ·æ–°æ•°æ®
  if (e.key === "F5") {
    e.preventDefault();
    loadDatabaseData();
  }
});
</script>
</body>
</html>
