<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>å¤ªå²ç¯ç™»è®°æ•°æ®ç®¡ç†</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
    background-color: #f8f9fa;
    color: #333;
    line-height: 1.6;
    padding: 20px;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    background-color: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  }
  
  .header {
    text-align: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eaeaea;
  }
  
  .header h1 {
    color: #2c3e50;
    font-size: 24px;
    margin-bottom: 8px;
  }
  
  .header .subtitle {
    color: #7f8c8d;
    font-size: 14px;
  }
  
  /* çŠ¶æ€æ  */
  .status-bar {
    background-color: #e8f4fd;
    padding: 12px 15px;
    border-radius: 6px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 14px;
  }
  
  .status-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .status-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
  }
  
  .status-online { background-color: #2ecc71; }
  .status-offline { background-color: #e74c3c; }
  .status-loading { background-color: #f39c12; animation: pulse 1.5s infinite; }
  
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }
  
  /* æ¶ˆæ¯æç¤º */
  .message {
    padding: 12px 15px;
    border-radius: 6px;
    margin-bottom: 15px;
    font-size: 14px;
    text-align: center;
    display: none;
  }
  
  .message.show {
    display: block;
  }
  
  .message.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }
  
  .message.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
  
  .message.warning {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
  }
  
  .message.info {
    background-color: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
  }
  
  /* æ“ä½œæ  */
  .action-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eaeaea;
  }
  
  .btn {
    padding: 10px 18px;
    border: none;
    border-radius: 5px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  
  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  .btn-primary {
    background-color: #3498db;
    color: white;
  }
  
  .btn-primary:hover:not(:disabled) {
    background-color: #2980b9;
  }
  
  .btn-danger {
    background-color: #e74c3c;
    color: white;
  }
  
  .btn-danger:hover:not(:disabled) {
    background-color: #c0392b;
  }
  
  .btn-success {
    background-color: #2ecc71;
    color: white;
  }
  
  .btn-success:hover:not(:disabled) {
    background-color: #27ae60;
  }
  
  .btn-warning {
    background-color: #f39c12;
    color: white;
  }
  
  .btn-warning:hover:not(:disabled) {
    background-color: #d68910;
  }
  
  .btn-secondary {
    background-color: #95a5a6;
    color: white;
  }
  
  .btn-secondary:hover:not(:disabled) {
    background-color: #7f8c8d;
  }
  
  /* é€‰æ‹©æ“ä½œæ  */
  .selection-bar {
    background-color: #f8f9fa;
    padding: 12px 15px;
    border-radius: 6px;
    margin-bottom: 15px;
    display: none;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #eaeaea;
  }
  
  .selection-bar.show {
    display: flex;
  }
  
  .selection-info {
    font-weight: 500;
    color: #3498db;
  }
  
  /* æœç´¢æ¡† */
  .search-box {
    margin-bottom: 20px;
  }
  
  .search-box input {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
    transition: border-color 0.2s;
  }
  
  .search-box input:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
  }
  
  /* è¡¨æ ¼ */
  .table-container {
    overflow-x: auto;
    border: 1px solid #eaeaea;
    border-radius: 6px;
    background-color: white;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
  }
  
  thead {
    background-color: #f8f9fa;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  th {
    padding: 14px 12px;
    text-align: left;
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #eaeaea;
    font-size: 13px;
    white-space: nowrap;
  }
  
  td {
    padding: 12px;
    border-bottom: 1px solid #eaeaea;
    font-size: 13px;
    vertical-align: middle;
  }
  
  tbody tr:hover {
    background-color: #f8f9fa;
  }
  
  tbody tr.selected {
    background-color: #e3f2fd !important;
  }
  
  /* å¤é€‰æ¡† */
  .checkbox-cell {
    width: 40px;
    text-align: center;
  }
  
  .checkbox {
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: #3498db;
  }
  
  /* æ“ä½œæŒ‰é’® */
  .action-cell {
    white-space: nowrap;
  }
  
  .action-btn {
    padding: 5px 10px;
    font-size: 12px;
    border-radius: 3px;
    border: none;
    cursor: pointer;
    margin: 2px;
  }
  
  .action-btn.view {
    background-color: #3498db;
    color: white;
  }
  
  .action-btn.delete {
    background-color: #e74c3c;
    color: white;
  }
  
  /* åŠ è½½åŠ¨ç”» */
  .loader {
    text-align: center;
    padding: 40px;
    color: #7f8c8d;
  }
  
  .loader .spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* ç©ºçŠ¶æ€ */
  .empty-state {
    text-align: center;
    padding: 50px 20px;
    color: #7f8c8d;
  }
  
  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.5;
  }
  
  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    body {
      padding: 10px;
    }
    
    .container {
      padding: 15px;
    }
    
    .action-bar {
      flex-direction: column;
    }
    
    .btn {
      width: 100%;
      justify-content: center;
    }
    
    th, td {
      padding: 10px 8px;
      font-size: 12px;
    }
  }
  
  /* ç¡®è®¤å¯¹è¯æ¡† */
  .confirm-dialog {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    padding: 20px;
  }
  
  .confirm-dialog.show {
    display: flex;
  }
  
  .confirm-content {
    background: white;
    padding: 25px;
    border-radius: 8px;
    max-width: 400px;
    width: 100%;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  }
  
  .confirm-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 10px;
    color: #2c3e50;
  }
  
  .confirm-message {
    margin-bottom: 20px;
    color: #555;
    line-height: 1.5;
  }
  
  .confirm-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }
</style>
</head>
<body>
  <div class="container">
    <!-- å¤´éƒ¨ -->
    <div class="header">
      <h1>å¤ªå²ç¯ç™»è®°æ•°æ®ç®¡ç†</h1>
      <div class="subtitle">å¤§è‡ªåœ¨å±±æ–°æ˜¥ç¥ˆç¦æ³•ä¼š Â· å®æ—¶æ•°æ®åº“ç®¡ç†</div>
    </div>
    
    <!-- çŠ¶æ€æ  -->
    <div class="status-bar">
      <div class="status-left">
        <span class="status-indicator status-loading" id="statusIndicator"></span>
        <span id="statusText">æ­£åœ¨è¿æ¥æ•°æ®åº“...</span>
      </div>
      <div>
        è®°å½•æ•°: <span id="recordCount">0</span>
      </div>
    </div>
    
    <!-- æ¶ˆæ¯æç¤º -->
    <div class="message" id="message"></div>
    
    <!-- é€‰æ‹©æ“ä½œæ  -->
    <div class="selection-bar" id="selectionBar">
      <div class="selection-info">
        <span id="selectedCount">0</span> é¡¹å·²é€‰æ‹©
      </div>
      <div>
        <button class="btn btn-danger" onclick="deleteSelected()">åˆ é™¤é€‰ä¸­é¡¹</button>
        <button class="btn btn-secondary" onclick="clearSelection()">å–æ¶ˆé€‰æ‹©</button>
      </div>
    </div>
    
    <!-- æ“ä½œæ  -->
    <div class="action-bar">
      <button class="btn btn-primary" onclick="loadData()">
        <span>â†»</span> åˆ·æ–°æ•°æ®
      </button>
      <button class="btn btn-success" onclick="exportData()">
        <span>â†“</span> å¯¼å‡ºæ•°æ®
      </button>
      <button class="btn btn-warning" onclick="selectAllRows()">
        <span>âœ“</span> å…¨é€‰
      </button>
      <button class="btn btn-warning" onclick="clearSelection()">
        <span>âœ—</span> å–æ¶ˆå…¨é€‰
      </button>
      <button class="btn btn-secondary" onclick="addTestRecord()">
        <span>+</span> æ·»åŠ æµ‹è¯•è®°å½•
      </button>
    </div>
    
    <!-- æœç´¢æ¡† -->
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="æœç´¢å§“åã€ç”Ÿè‚–æˆ–è”ç³»äºº..." 
             oninput="filterTable()">
    </div>
    
    <!-- è¡¨æ ¼ -->
    <div class="table-container">
      <table id="dataTable">
        <thead>
          <tr>
            <th class="checkbox-cell">
              <input type="checkbox" class="checkbox" id="selectAll" onclick="toggleSelectAll(this)">
            </th>
            <th>åºå·</th>
            <th>å§“å</th>
            <th>ç”Ÿè‚–</th>
            <th>æŠ¤æŒé‡‘é¢ (å°å¸)</th>
            <th>æŠ¤æŒé‡‘é¢ (äººæ°‘å¸)</th>
            <th>è”ç³»äºº</th>
            <th>æäº¤æ—¶é—´</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- æ•°æ®é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </tbody>
      </table>
      
      <!-- åŠ è½½çŠ¶æ€ -->
      <div class="loader" id="loader">
        <div class="spinner"></div>
        <div>æ­£åœ¨åŠ è½½æ•°æ®...</div>
      </div>
      
      <!-- ç©ºçŠ¶æ€ -->
      <div class="empty-state" id="emptyState" style="display: none;">
        <div class="empty-state-icon">ğŸ“­</div>
        <div style="font-size: 16px; margin-bottom: 10px;">æš‚æ— æ•°æ®</div>
        <div style="color: #95a5a6; font-size: 14px;">ç‚¹å‡»"æ·»åŠ æµ‹è¯•è®°å½•"åˆ›å»ºç¬¬ä¸€æ¡æ•°æ®</div>
      </div>
    </div>
  </div>
  
  <!-- ç¡®è®¤å¯¹è¯æ¡† -->
  <div class="confirm-dialog" id="confirmDialog">
    <div class="confirm-content">
      <div class="confirm-title" id="confirmTitle">ç¡®è®¤æ“ä½œ</div>
      <div class="confirm-message" id="confirmMessage"></div>
      <div class="confirm-actions">
        <button class="btn btn-secondary" onclick="cancelConfirm()">å–æ¶ˆ</button>
        <button class="btn btn-danger" onclick="executeConfirm()">ç¡®è®¤</button>
      </div>
    </div>
  </div>

<script>
// é…ç½®
const CONFIG = {
  API_BASE: window.location.origin + "/api"
};

// å…¨å±€å˜é‡
let allRecords = [];          // æ‰€æœ‰æ•°æ®åº“è®°å½•
let filteredRecords = [];     // è¿‡æ»¤åçš„è®°å½•
let selectedIds = new Set();  // é€‰ä¸­çš„è®°å½•ID
let pendingAction = null;     // å¾…ç¡®è®¤çš„æ“ä½œ

// DOMå…ƒç´ 
const statusIndicator = document.getElementById('statusIndicator');
const statusText = document.getElementById('statusText');
const recordCount = document.getElementById('recordCount');
const message = document.getElementById('message');
const selectionBar = document.getElementById('selectionBar');
const selectedCount = document.getElementById('selectedCount');
const searchInput = document.getElementById('searchInput');
const tableBody = document.getElementById('tableBody');
const loader = document.getElementById('loader');
const emptyState = document.getElementById('emptyState');
const confirmDialog = document.getElementById('confirmDialog');
const confirmTitle = document.getElementById('confirmTitle');
const confirmMessage = document.getElementById('confirmMessage');

// ==================== çŠ¶æ€ç®¡ç† ====================

// æ›´æ–°çŠ¶æ€
function updateStatus(type, text) {
  statusIndicator.className = 'status-indicator';
  switch(type) {
    case 'loading':
      statusIndicator.classList.add('status-loading');
      break;
    case 'online':
      statusIndicator.classList.add('status-online');
      break;
    case 'offline':
      statusIndicator.classList.add('status-offline');
      break;
  }
  statusText.textContent = text;
}

// æ˜¾ç¤ºæ¶ˆæ¯
function showMessage(text, type = 'info', duration = 0) {
  message.textContent = text;
  message.className = `message ${type} show`;
  
  if (duration > 0) {
    setTimeout(() => {
      message.classList.remove('show');
    }, duration);
  }
}

// éšè—æ¶ˆæ¯
function hideMessage() {
  message.classList.remove('show');
}

// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
function showLoader() {
  loader.style.display = 'block';
  tableBody.innerHTML = '';
}

// éšè—åŠ è½½çŠ¶æ€
function hideLoader() {
  loader.style.display = 'none';
}

// ==================== æ•°æ®æ“ä½œ ====================

// åŠ è½½æ•°æ®
async function loadData() {
  showLoader();
  updateStatus('loading', 'æ­£åœ¨åŠ è½½æ•°æ®...');
  hideMessage();
  
  try {
    const response = await fetch(CONFIG.API_BASE + '/data');
    const result = await response.json();
    
    if (response.ok && result.ok) {
      allRecords = result.data || [];
      filteredRecords = [...allRecords];
      
      renderTable();
      updateStatus('online', 'æ•°æ®åŠ è½½å®Œæˆ');
      recordCount.textContent = allRecords.length;
      
      if (allRecords.length === 0) {
        emptyState.style.display = 'block';
      } else {
        emptyState.style.display = 'none';
      }
      
    } else {
      throw new Error(result.error || 'åŠ è½½æ•°æ®å¤±è´¥');
    }
    
  } catch (error) {
    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
    updateStatus('offline', 'åŠ è½½å¤±è´¥');
    showMessage(`åŠ è½½å¤±è´¥: ${error.message}`, 'error');
    tableBody.innerHTML = `
      <tr>
        <td colspan="9" style="text-align: center; padding: 30px; color: #e74c3c;">
          æ•°æ®åŠ è½½å¤±è´¥: ${error.message}
        </td>
      </tr>
    `;
    emptyState.style.display = 'block';
  } finally {
    hideLoader();
  }
}

// æ¸²æŸ“è¡¨æ ¼
function renderTable() {
  if (filteredRecords.length === 0) {
    tableBody.innerHTML = `
      <tr>
        <td colspan="9" style="text-align: center; padding: 30px; color: #95a5a6;">
          æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è®°å½•
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  
  filteredRecords.forEach((record, index) => {
    const isSelected = selectedIds.has(record.id);
    const time = record.created_time ? formatTime(record.created_time) : '-';
    
    html += `
      <tr ${isSelected ? 'class="selected"' : ''}>
        <td class="checkbox-cell">
          <input type="checkbox" class="checkbox" 
                 data-id="${record.id}"
                 ${isSelected ? 'checked' : ''}
                 onchange="toggleRowSelection('${record.id}')">
        </td>
        <td>${index + 1}</td>
        <td><strong>${escapeHtml(record.name || '')}</strong></td>
        <td>${escapeHtml(record.zodiac || '')}</td>
        <td style="text-align: right; color: #e74c3c;">${formatNumber(record.amountNTD || 0)}</td>
        <td style="text-align: right; color: #2ecc71;">${formatNumber(record.amountCNY || 0)}</td>
        <td>${escapeHtml(record.contact || '')}</td>
        <td style="font-size: 12px;">${time}</td>
        <td class="action-cell">
          <button class="action-btn view" onclick="viewInNotion('${record.id}')">æŸ¥çœ‹</button>
          <button class="action-btn delete" onclick="deleteRecord('${record.id}', '${record.name}')">åˆ é™¤</button>
        </td>
      </tr>
    `;
  });
  
  tableBody.innerHTML = html;
  updateSelectionUI();
}

// è¿‡æ»¤è¡¨æ ¼
function filterTable() {
  const keyword = searchInput.value.trim().toLowerCase();
  
  if (!keyword) {
    filteredRecords = [...allRecords];
  } else {
    filteredRecords = allRecords.filter(record => {
      return (
        (record.name && record.name.toLowerCase().includes(keyword)) ||
        (record.zodiac && record.zodiac.toLowerCase().includes(keyword)) ||
        (record.contact && record.contact.toLowerCase().includes(keyword)) ||
        (record.amountNTD && record.amountNTD.toString().includes(keyword)) ||
        (record.amountCNY && record.amountCNY.toString().includes(keyword))
      );
    });
  }
  
  renderTable();
  recordCount.textContent = filteredRecords.length;
}

// ==================== é€‰æ‹©æ“ä½œ ====================

// æ›´æ–°é€‰æ‹©UI
function updateSelectionUI() {
  const selected = selectedIds.size;
  selectedCount.textContent = selected;
  
  if (selected > 0) {
    selectionBar.classList.add('show');
  } else {
    selectionBar.classList.remove('show');
  }
  
  // æ›´æ–°å…¨é€‰å¤é€‰æ¡†
  const selectAllCheckbox = document.getElementById('selectAll');
  if (selectAllCheckbox) {
    const allVisibleIds = new Set(filteredRecords.map(r => r.id));
    const allVisibleSelected = Array.from(selectedIds).every(id => allVisibleIds.has(id));
    selectAllCheckbox.checked = selected > 0 && allVisibleSelected;
    selectAllCheckbox.indeterminate = selected > 0 && !allVisibleSelected;
  }
}

// åˆ‡æ¢å…¨é€‰
function toggleSelectAll(checkbox) {
  const allVisibleIds = filteredRecords.map(r => r.id);
  
  if (checkbox.checked) {
    allVisibleIds.forEach(id => selectedIds.add(id));
  } else {
    allVisibleIds.forEach(id => selectedIds.delete(id));
  }
  
  renderTable();
}

// å…¨é€‰
function selectAllRows() {
  filteredRecords.forEach(record => selectedIds.add(record.id));
  renderTable();
}

// æ¸…é™¤é€‰æ‹©
function clearSelection() {
  selectedIds.clear();
  renderTable();
}

// åˆ‡æ¢å•è¡Œé€‰æ‹©
function toggleRowSelection(id) {
  if (selectedIds.has(id)) {
    selectedIds.delete(id);
  } else {
    selectedIds.add(id);
  }
  renderTable();
}

// ==================== åˆ é™¤æ“ä½œ ====================

// åˆ é™¤å•æ¡è®°å½•
function deleteRecord(id, name) {
  showConfirm(
    'ç¡®è®¤åˆ é™¤',
    `ç¡®å®šè¦åˆ é™¤è®°å½• "<strong>${escapeHtml(name)}</strong>" å—ï¼Ÿ<br>æ­¤æ“ä½œä¸å¯æ¢å¤ï¼`,
    async () => {
      await performDelete(id, name);
    }
  );
}

// åˆ é™¤é€‰ä¸­é¡¹
function deleteSelected() {
  if (selectedIds.size === 0) {
    showMessage('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®°å½•', 'warning', 3000);
    return;
  }
  
  const names = Array.from(selectedIds)
    .map(id => {
      const record = allRecords.find(r => r.id === id);
      return record ? record.name : 'æœªçŸ¥è®°å½•';
    })
    .slice(0, 3)
    .join(', ');
  
  const recordList = selectedIds.size > 3 ? `${names}...ç­‰` : names;
  
  showConfirm(
    'æ‰¹é‡åˆ é™¤ç¡®è®¤',
    `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ <strong>${selectedIds.size}</strong> æ¡è®°å½•å—ï¼Ÿ<br><br>æ¶‰åŠè®°å½•ï¼š${recordList}<br><br>æ­¤æ“ä½œä¸å¯æ¢å¤ï¼`,
    async () => {
      await performBatchDelete();
    }
  );
}

// æ‰§è¡Œåˆ é™¤æ“ä½œ
async function performDelete(id, name) {
  updateStatus('loading', 'æ­£åœ¨åˆ é™¤...');
  showMessage('æ­£åœ¨åˆ é™¤è®°å½•...', 'info');
  
  try {
    const response = await fetch(CONFIG.API_BASE + '/delete', {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ id: id })
    });
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      // ä»æœ¬åœ°æ•°æ®ä¸­ç§»é™¤
      allRecords = allRecords.filter(record => record.id !== id);
      filteredRecords = [...allRecords];
      selectedIds.delete(id);
      
      // æ›´æ–°UI
      renderTable();
      updateStatus('online', 'åˆ é™¤æˆåŠŸ');
      showMessage(`è®°å½• "${name}" åˆ é™¤æˆåŠŸ`, 'success', 3000);
      recordCount.textContent = allRecords.length;
      
    } else {
      throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
    }
    
  } catch (error) {
    console.error('åˆ é™¤å¤±è´¥:', error);
    updateStatus('offline', 'åˆ é™¤å¤±è´¥');
    showMessage(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error', 5000);
  }
}

// æ‰§è¡Œæ‰¹é‡åˆ é™¤
async function performBatchDelete() {
  const ids = Array.from(selectedIds);
  const total = ids.length;
  let successCount = 0;
  let failCount = 0;
  
  updateStatus('loading', `æ­£åœ¨æ‰¹é‡åˆ é™¤ (0/${total})...`);
  showMessage(`å¼€å§‹æ‰¹é‡åˆ é™¤ ${total} æ¡è®°å½•...`, 'info');
  
  for (let i = 0; i < ids.length; i++) {
    const id = ids[i];
    
    try {
      // æ›´æ–°è¿›åº¦
      updateStatus('loading', `æ­£åœ¨æ‰¹é‡åˆ é™¤ (${i + 1}/${total})...`);
      
      const response = await fetch(CONFIG.API_BASE + '/delete', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ id: id })
      });
      
      const result = await response.json();
      
      if (response.ok && result.ok) {
        successCount++;
      } else {
        failCount++;
        console.error(`åˆ é™¤è®°å½• ${id} å¤±è´¥:`, result.error);
      }
      
    } catch (error) {
      failCount++;
      console.error(`åˆ é™¤è®°å½• ${id} å¤±è´¥:`, error);
    }
    
    // çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…è¯·æ±‚è¿‡å¿«
    await new Promise(resolve => setTimeout(resolve, 300));
  }
  
  // é‡æ–°åŠ è½½æ•°æ®
  await loadData();
  
  // æ˜¾ç¤ºç»“æœ
  if (failCount === 0) {
    showMessage(`æˆåŠŸåˆ é™¤ ${successCount} æ¡è®°å½•`, 'success', 5000);
  } else {
    showMessage(`åˆ é™¤å®Œæˆ: æˆåŠŸ ${successCount} æ¡ï¼Œå¤±è´¥ ${failCount} æ¡`, 
                failCount === 0 ? 'success' : 'warning', 5000);
  }
  
  updateStatus('online', 'æ‰¹é‡åˆ é™¤å®Œæˆ');
}

// ==================== å…¶ä»–åŠŸèƒ½ ====================

// å¯¼å‡ºæ•°æ®
function exportData() {
  if (allRecords.length === 0) {
    showMessage('æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡º', 'warning', 3000);
    return;
  }
  
  try {
    // CSVè¡¨å¤´
    const headers = ['åºå·', 'å§“å', 'ç”Ÿè‚–', 'æŠ¤æŒé‡‘é¢å°å¸', 'äººæ°‘å¸', 'è”ç³»äºº', 'æäº¤æ—¶é—´'];
    const csvRows = [headers.join(',')];
    
    allRecords.forEach((record, index) => {
      const time = record.created_time ? formatTime(record.created_time) : '-';
      const row = [
        index + 1,
        `"${record.name || ''}"`,
        `"${record.zodiac || ''}"`,
        record.amountNTD || 0,
        record.amountCNY || 0,
        `"${record.contact || ''}"`,
        `"${time}"`
      ];
      csvRows.push(row.join(','));
    });
    
    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const csvContent = '\uFEFF' + csvRows.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    
    link.href = url;
    link.download = `å¤ªå²ç¯æ•°æ®_${timestamp}_${allRecords.length}æ¡.csv`;
    link.style.display = 'none';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    URL.revokeObjectURL(url);
    
    showMessage(`æˆåŠŸå¯¼å‡º ${allRecords.length} æ¡è®°å½•`, 'success', 3000);
    
  } catch (error) {
    console.error('å¯¼å‡ºå¤±è´¥:', error);
    showMessage(`å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error', 5000);
  }
}

// æ·»åŠ æµ‹è¯•è®°å½•
async function addTestRecord() {
  const name = prompt('è¯·è¾“å…¥å§“å:', `æµ‹è¯•ç”¨æˆ·_${Date.now().toString().slice(-6)}`);
  if (!name) return;
  
  const zodiac = prompt('è¯·é€‰æ‹©ç”Ÿè‚–:', 'è‚–é©¬');
  if (!zodiac) return;
  
  const amountStr = prompt('è¯·è¾“å…¥æŠ¤æŒé‡‘é¢ï¼ˆå°å¸ï¼‰:', '1200');
  const amountNTD = parseInt(amountStr) || 1200;
  const amountCNY = Math.round(amountNTD / 4.2);
  
  const contact = prompt('è¯·è¾“å…¥è”ç³»äºº:', 'æµ‹è¯•è”ç³»äºº');
  if (!contact) return;
  
  updateStatus('loading', 'æ­£åœ¨æäº¤...');
  showMessage('æ­£åœ¨æäº¤è®°å½•...', 'info');
  
  try {
    const response = await fetch(CONFIG.API_BASE + '/submit', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        title: name,
        zodiac: zodiac,
        "æŠ¤æŒé‡‘é¢å°å¸": amountNTD,
        äººæ°‘å¸: amountCNY,
        è”ç³»äºº: contact
      })
    });
    
    const result = await response.json();
    
    if (response.ok && (result.ok || result.pageId)) {
      showMessage('æµ‹è¯•è®°å½•æäº¤æˆåŠŸ', 'success', 3000);
      
      // å»¶è¿Ÿååˆ·æ–°æ•°æ®
      setTimeout(() => {
        loadData();
      }, 1000);
      
    } else {
      throw new Error(result.error || 'æäº¤å¤±è´¥');
    }
    
  } catch (error) {
    console.error('æäº¤å¤±è´¥:', error);
    showMessage(`æäº¤å¤±è´¥: ${error.message}`, 'error', 5000);
  } finally {
    updateStatus('online', 'æäº¤å®Œæˆ');
  }
}

// åœ¨Notionä¸­æŸ¥çœ‹
function viewInNotion(id) {
  window.open(`https://notion.so/${id.replace(/-/g, '')}`, '_blank');
}

// ==================== å·¥å…·å‡½æ•° ====================

// æ ¼å¼åŒ–æ—¶é—´
function formatTime(isoString) {
  try {
    const date = new Date(isoString);
    return `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
  } catch (e) {
    return isoString;
  }
}

// æ ¼å¼åŒ–æ•°å­—
function formatNumber(num) {
  return Number(num).toLocaleString();
}

// è½¬ä¹‰HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ==================== ç¡®è®¤å¯¹è¯æ¡† ====================

// æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
function showConfirm(title, message, callback) {
  confirmTitle.textContent = title;
  confirmMessage.innerHTML = message;
  pendingAction = callback;
  confirmDialog.classList.add('show');
}

// å–æ¶ˆç¡®è®¤
function cancelConfirm() {
  confirmDialog.classList.remove('show');
  pendingAction = null;
}

// æ‰§è¡Œç¡®è®¤æ“ä½œ
function executeConfirm() {
  confirmDialog.classList.remove('show');
  if (pendingAction) {
    pendingAction();
    pendingAction = null;
  }
}

// ==================== åˆå§‹åŒ– ====================

// åˆå§‹åŒ–
async function init() {
  console.log('å¤ªå²ç¯ç®¡ç†ç³»ç»Ÿåˆå§‹åŒ–...');
  console.log('APIåœ°å€:', CONFIG.API_BASE);
  
  // è‡ªåŠ¨åŠ è½½æ•°æ®
  await loadData();
  
  // æ·»åŠ é”®ç›˜å¿«æ·é”®
  document.addEventListener('keydown', (e) => {
    // Ctrl+F èšç„¦æœç´¢æ¡†
    if (e.ctrlKey && e.key === 'f') {
      e.preventDefault();
      searchInput.focus();
    }
    
    // F5 åˆ·æ–°
    if (e.key === 'F5') {
      e.preventDefault();
      loadData();
    }
    
    // Escape æ¸…é™¤é€‰æ‹©
    if (e.key === 'Escape') {
      clearSelection();
      searchInput.value = '';
      filterTable();
    }
    
    // Ctrl+A å…¨é€‰å¯è§é¡¹
    if (e.ctrlKey && e.key === 'a') {
      e.preventDefault();
      selectAllRows();
    }
  });
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
