<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>å¤§è‡ªåœ¨å±±æ–°æ˜¥ç¥ˆç¦æ³•ä¼š-å¤ªå²ç¯2026ç®¡ç†é¡µé¢</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: system-ui, -apple-system, "PingFang SC","Microsoft YaHei", Arial;
    background-color: #f5f5f5;
    color: #333;
    line-height: 1.6;
    padding: 15px;
  }
  
  .container {
    max-width: 900px;
    margin: 0 auto;
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  
  h1 {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 20px;
    font-size: 24px;
  }
  
  .msg {
    margin: 15px 0;
    padding: 12px;
    border-radius: 4px;
    text-align: center;
    font-size: 14px;
  }
  
  .ok {
    color: #0a7d33;
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
  }
  
  .err {
    color: #b80000;
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
  }
  
  .info {
    color: #0c5460;
    background-color: #d1ecf1;
    border: 1px solid #bee5eb;
  }
  
  h2 {
    color: #34495e;
    margin-bottom: 15px;
    font-size: 20px;
  }
  
  /* æŒ‰é’®æ ·å¼ */
  .btn {
    padding: 12px 20px;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: bold;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  
  .btn i {
    font-size: 14px;
  }
  
  .btn-primary {
    background-color: #3498db;
    color: white;
  }
  
  .btn-primary:hover {
    background-color: #2980b9;
  }
  
  .btn-secondary {
    background-color: #95a5a6;
    color: white;
  }
  
  .btn-secondary:hover {
    background-color: #7f8c8d;
  }
  
  .btn-success {
    background-color: #2ecc71;
    color: white;
  }
  
  .btn-success:hover {
    background-color: #27ae60;
  }
  
  .btn-danger {
    background-color: #e74c3c;
    color: white;
    padding: 8px 15px;
    font-size: 14px;
  }
  
  .btn-danger:hover {
    background-color: #c0392b;
  }
  
  .btn-warning {
    background-color: #f39c12;
    color: white;
  }
  
  .btn-warning:hover {
    background-color: #d68910;
  }
  
  /* è¡¨æ ¼æ ·å¼ */
  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 20px;
    background-color: white;
  }
  
  th, td {
    border: 1px solid #ddd;
    padding: 12px;
    text-align: left;
    white-space: nowrap;
    font-size: 14px;
  }
  
  th {
    background-color: #f2f2f2;
    font-weight: bold;
    color: #555;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  
  tr:nth-child(even) {
    background-color: #f9f9f9;
  }
  
  tr:hover {
    background-color: #f5f5f5;
  }
  
  /* æ— æ•°æ®æç¤º */
  .no-data {
    text-align: center;
    padding: 30px;
    color: #666;
    font-size: 16px;
    background-color: #fafafa;
    border-radius: 4px;
    margin: 20px 0;
  }
  
  /* æŒ‰é’®ç»„ */
  .btn-group {
    margin-bottom: 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
  }
  
  /* è¿”å›é“¾æ¥ */
  .back-link {
    display: inline-block;
    margin-top: 20px;
    color: #3498db;
    text-decoration: none;
    font-size: 14px;
  }
  
  .back-link:hover {
    text-decoration: underline;
  }
  
  /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
  .status-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 8px;
  }
  
  .status-online {
    background-color: #2ecc71;
  }
  
  .status-offline {
    background-color: #e74c3c;
  }
  
  .status-warning {
    background-color: #f39c12;
  }
  
  /* ç»Ÿè®¡å¡ç‰‡ */
  .stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin: 20px 0;
  }
  
  .stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
  }
  
  .stat-card h3 {
    margin: 0 0 10px 0;
    font-size: 14px;
    opacity: 0.9;
  }
  
  .stat-card .value {
    font-size: 24px;
    font-weight: bold;
  }
  
  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    body {
      padding: 10px;
    }
    
    .container {
      padding: 15px;
    }
    
    h1 {
      font-size: 20px;
    }
    
    h2 {
      font-size: 18px;
    }
    
    .btn {
      padding: 10px 16px;
      font-size: 14px;
    }
    
    table {
      font-size: 12px;
      display: block;
      overflow-x: auto;
    }
    
    th, td {
      padding: 8px;
      font-size: 12px;
    }
    
    .btn-group {
      flex-direction: column;
    }
    
    .btn {
      width: 100%;
    }
  }
  
  /* è¡¨æ ¼å®¹å™¨ */
  .table-container {
    overflow-x: auto;
    margin-top: 20px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
  }
  
  /* åŠ è½½åŠ¨ç”» */
  .loader {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
</head>
<body>
  <div class="container">
    <h1>å¤§è‡ªåœ¨å±±æ–°æ˜¥ç¥ˆç¦æ³•ä¼š-å¤ªå²ç¯2026ç®¡ç†é¡µé¢</h1>
    
    <!-- çŠ¶æ€æ  -->
    <div id="statusBar" class="msg info">
      <span id="statusIcon" class="status-indicator status-offline"></span>
      <span id="statusText">æ­£åœ¨æ£€æŸ¥æ•°æ®åº“è¿æ¥...</span>
    </div>
    
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div id="statsContainer" class="stats-container" style="display: none;">
      <div class="stat-card">
        <h3>æ€»è®°å½•æ•°</h3>
        <div class="value" id="totalCount">0</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <h3>æŠ¤æŒæ€»é‡‘é¢ (å°å¸)</h3>
        <div class="value" id="totalAmountNTD">0</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
        <h3>æŠ¤æŒæ€»é‡‘é¢ (äººæ°‘å¸)</h3>
        <div class="value" id="totalAmountCNY">0</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
        <h3>æœ€åæ›´æ–°æ—¶é—´</h3>
        <div class="value" id="lastUpdate">-</div>
      </div>
    </div>
    
    <!-- æ¶ˆæ¯æç¤º -->
    <div id="msg" class="msg"></div>
    
    <!-- æŒ‰é’®ç»„ -->
    <div class="btn-group">
      <button class="btn btn-primary" onclick="loadData()">
        <span>ğŸ”„</span> ä»æ•°æ®åº“åŠ è½½
      </button>
      <button class="btn btn-success" onclick="exportData()">
        <span>ğŸ“Š</span> å¯¼å‡ºæ•°æ®
      </button>
      <button class="btn btn-warning" onclick="syncToDatabase()">
        <span>ğŸ“¤</span> åŒæ­¥åˆ°æ•°æ®åº“
      </button>
      <button class="btn btn-secondary" onclick="refreshLocalData()">
        <span>ğŸ’¾</span> åˆ·æ–°æœ¬åœ°æ•°æ®
      </button>
      <button class="btn btn-danger" onclick="clearLocalData()">
        <span>ğŸ—‘ï¸</span> æ¸…ç©ºæœ¬åœ°æ•°æ®
      </button>
    </div>
    
    <!-- åŠ è½½åŠ¨ç”» -->
    <div id="loader" class="loader" style="display: none;"></div>
    
    <!-- è¡¨æ ¼å®¹å™¨ -->
    <div class="table-container">
      <table id="dataTable">
        <thead>
          <tr>
            <th>åºå·</th>
            <th>å§“å</th>
            <th>ç”Ÿè‚–</th>
            <th>æŠ¤æŒé‡‘é¢å°å¸</th>
            <th>äººæ°‘å¸</th>
            <th>è”ç³»äºº</th>
            <th>æäº¤æ—¶é—´</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="dataTableBody"></tbody>
      </table>
    </div>
    
    <!-- æ— æ•°æ®æç¤º -->
    <div id="noData" class="no-data" style="display: none;">
      <div>ğŸ“­</div>
      <div style="margin-top: 10px;">æš‚æ— ç™»è®°æ•°æ®</div>
      <div style="margin-top: 10px; font-size: 14px; color: #888;">
        è¯·ä»æ•°æ®åº“åŠ è½½æˆ–ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ•°æ®
      </div>
    </div>
    
    <!-- è¿”å›é“¾æ¥ -->
    <div style="text-align: center; margin-top: 30px;">
      <a href="index.html" class="back-link">â¬…ï¸ è¿”å›ç™»è®°é¡µé¢</a>
      <span style="margin: 0 10px; color: #ddd">|</span>
      <a href="javascript:void(0)" onclick="testConnection()" class="back-link">ğŸ”§ æµ‹è¯•è¿æ¥</a>
      <span style="margin: 0 10px; color: #ddd">|</span>
      <a href="javascript:void(0)" onclick="showDebugInfo()" class="back-link">ğŸ› è°ƒè¯•ä¿¡æ¯</a>
    </div>
  </div>

<script>
// é…ç½®
const CONFIG = {
  STORAGE_KEY: "taishui_records_2026",
  API_BASE: window.location.origin + "/api",
  EXCHANGE_RATE: 4.2
};

// DOMå…ƒç´ 
const msgElement = document.getElementById("msg");
const statusBar = document.getElementById("statusBar");
const statusIcon = document.getElementById("statusIcon");
const statusText = document.getElementById("statusText");
const dataTableBody = document.getElementById("dataTableBody");
const noDataElement = document.getElementById("noData");
const loader = document.getElementById("loader");
const statsContainer = document.getElementById("statsContainer");

// ç”Ÿè‚–æ˜ å°„
const ZODIAC_MAP = {
  "è‚–é©¬": "è‚–é©¬ï¼šå€¼å¤ªå²ã€åˆ‘å¤ªå²",
  "è‚–é¼ ": "è‚–é¼ ï¼šå†²å¤ªå²",
  "è‚–å…”": "è‚–å…”ï¼šç ´å¤ªå²",
  "è‚–ç‰›": "è‚–ç‰›ï¼šå®³å¤ªå²",
  "è‚–é¸¡": "è‚–é¸¡ï¼šå®³å¤ªå²ã€åˆ‘å¤ªå²"
};

// è®¾ç½®æ¶ˆæ¯
function setMsg(text, type = "") {
  msgElement.className = "msg " + type;
  msgElement.textContent = text;
  msgElement.style.display = text ? "block" : "none";
  
  // è‡ªåŠ¨æ¸…é™¤æ¶ˆæ¯
  if (text && type === "ok") {
    setTimeout(() => {
      msgElement.style.display = "none";
    }, 3000);
  }
}

// æ›´æ–°çŠ¶æ€æ 
function updateStatus(iconClass, text) {
  statusIcon.className = "status-indicator " + iconClass;
  statusText.textContent = text;
}

// æ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
function showLoader(show) {
  loader.style.display = show ? "block" : "none";
}

// è¯»å–æœ¬åœ°å­˜å‚¨æ•°æ®
function readLocalData() {
  try {
    const data = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEY) || "[]");
    console.log("è¯»å–æœ¬åœ°æ•°æ®:", data.length, "æ¡è®°å½•");
    return data;
  } catch (e) {
    console.error("è¯»å–æœ¬åœ°æ•°æ®å¤±è´¥:", e);
    return [];
  }
}

// å†™å…¥æœ¬åœ°å­˜å‚¨æ•°æ®
function writeLocalData(data) {
  try {
    localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(data));
    console.log("ä¿å­˜æœ¬åœ°æ•°æ®:", data.length, "æ¡è®°å½•");
    return true;
  } catch (e) {
    console.error("ä¿å­˜æœ¬åœ°æ•°æ®å¤±è´¥:", e);
    return false;
  }
}

// æ¸…ç©ºæœ¬åœ°æ•°æ®
function clearLocalData() {
  if (confirm("âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼")) {
    localStorage.removeItem(CONFIG.STORAGE_KEY);
    renderDataTable([]);
    updateStats([]);
    setMsg("æœ¬åœ°æ•°æ®å·²æ¸…ç©º", "ok");
  }
}

// ä»æ•°æ®åº“åŠ è½½æ•°æ®
async function loadData() {
  showLoader(true);
  updateStatus("status-warning", "æ­£åœ¨è¿æ¥æ•°æ®åº“...");
  
  try {
    // æ£€æŸ¥æ•°æ®åº“è¿æ¥
    const healthRes = await fetch(CONFIG.API_BASE + "/health");
    
    if (!healthRes.ok) {
      throw new Error("æ•°æ®åº“è¿æ¥å¤±è´¥: " + healthRes.status);
    }
    
    const healthData = await healthRes.json();
    
    if (healthData.ok) {
      updateStatus("status-online", "æ•°æ®åº“è¿æ¥æ­£å¸¸");
      
      // å¦‚æœæœ‰æ•°æ®APIï¼Œä»è¿™é‡Œè·å–æ•°æ®
      // ç›®å‰å…ˆä½¿ç”¨æœ¬åœ°æ•°æ®
      const localData = readLocalData();
      renderDataTable(localData);
      updateStats(localData);
      
      if (localData.length > 0) {
        setMsg(`ä»æœ¬åœ°åŠ è½½ ${localData.length} æ¡è®°å½•`, "ok");
      } else {
        setMsg("æ•°æ®åº“è¿æ¥æ­£å¸¸ï¼Œä½†æœ¬åœ°æš‚æ— æ•°æ®", "info");
      }
    } else {
      updateStatus("status-offline", "æ•°æ®åº“é…ç½®é”™è¯¯");
      setMsg("æ•°æ®åº“é…ç½®é”™è¯¯: " + (healthData.error || "æœªçŸ¥é”™è¯¯"), "err");
      
      // ä½¿ç”¨æœ¬åœ°æ•°æ®ä½œä¸ºåå¤‡
      const localData = readLocalData();
      if (localData.length > 0) {
        renderDataTable(localData);
        updateStats(localData);
        setMsg(`ä½¿ç”¨æœ¬åœ°æ•°æ® (${localData.length} æ¡è®°å½•)`, "info");
      }
    }
  } catch (error) {
    console.error("åŠ è½½æ•°æ®å¤±è´¥:", error);
    updateStatus("status-offline", "è¿æ¥å¤±è´¥: " + error.message);
    
    // ä½¿ç”¨æœ¬åœ°æ•°æ®
    const localData = readLocalData();
    renderDataTable(localData);
    updateStats(localData);
    
    if (localData.length > 0) {
      setMsg(`ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ® (${localData.length} æ¡è®°å½•)`, "err");
    } else {
      setMsg("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œä¸”æœ¬åœ°æ— æ•°æ®", "err");
    }
  } finally {
    showLoader(false);
  }
}

// åŒæ­¥æ•°æ®åˆ°æ•°æ®åº“
async function syncToDatabase() {
  const localData = readLocalData();
  
  if (localData.length === 0) {
    setMsg("æš‚æ— æ•°æ®éœ€è¦åŒæ­¥", "info");
    return;
  }
  
  if (!confirm(`ç¡®å®šè¦å°† ${localData.length} æ¡è®°å½•åŒæ­¥åˆ°æ•°æ®åº“å—ï¼Ÿ`)) {
    return;
  }
  
  showLoader(true);
  updateStatus("status-warning", "æ­£åœ¨åŒæ­¥æ•°æ®...");
  
  try {
    let successCount = 0;
    let errorCount = 0;
    const errors = [];
    
    for (let i = 0; i < localData.length; i++) {
      const record = localData[i];
      
      try {
        const response = await fetch(CONFIG.API_BASE + "/submit", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            title: record.name,
            zodiac: record.zodiac,
            "æŠ¤æŒé‡‘é¢å°å¸": record.amountNTD,
            äººæ°‘å¸: record.amountCNY,
            è”ç³»äºº: record.contact
          })
        });
        
        const result = await response.json();
        
        if (response.ok && result.ok) {
          successCount++;
        } else {
          errorCount++;
          errors.push(`è®°å½• ${i + 1} (${record.name}): ${result.error || "æœªçŸ¥é”™è¯¯"}`);
        }
        
        // å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
        await new Promise(resolve => setTimeout(resolve, 100));
        
      } catch (error) {
        errorCount++;
        errors.push(`è®°å½• ${i + 1} (${record.name}): ${error.message}`);
      }
    }
    
    if (errorCount === 0) {
      setMsg(`âœ… æˆåŠŸåŒæ­¥ ${successCount} æ¡è®°å½•åˆ°æ•°æ®åº“`, "ok");
      updateStatus("status-online", "åŒæ­¥å®Œæˆ");
    } else {
      setMsg(`âš ï¸ åŒæ­¥å®Œæˆ: æˆåŠŸ ${successCount} æ¡ï¼Œå¤±è´¥ ${errorCount} æ¡`, "err");
      
      if (errors.length > 0) {
        console.error("åŒæ­¥é”™è¯¯è¯¦æƒ…:", errors);
      }
    }
    
  } catch (error) {
    console.error("åŒæ­¥å¤±è´¥:", error);
    setMsg("åŒæ­¥å¤±è´¥: " + error.message, "err");
    updateStatus("status-offline", "åŒæ­¥å¤±è´¥");
  } finally {
    showLoader(false);
  }
}

// å¯¼å‡ºæ•°æ®
function exportData() {
  const data = readLocalData();
  
  if (data.length === 0) {
    setMsg("æš‚æ— æ•°æ®å¯å¯¼å‡º", "info");
    return;
  }
  
  try {
    // å‡†å¤‡CSVæ•°æ®
    const headers = ["åºå·", "å§“å", "ç”Ÿè‚–", "æŠ¤æŒé‡‘é¢å°å¸", "äººæ°‘å¸", "è”ç³»äºº", "æäº¤æ—¶é—´"];
    const csvRows = [headers.join(",")];
    
    let totalNTD = 0;
    let totalCNY = 0;
    
    data.forEach((row, index) => {
      totalNTD += row.amountNTD || 0;
      totalCNY += row.amountCNY || 0;
      
      const csvRow = [
        index + 1,
        `"${row.name || ""}"`,
        `"${row.zodiac || ""}"`,
        row.amountNTD || 0,
        row.amountCNY || 0,
        `"${row.contact || ""}"`,
        `"${row.timestamp ? new Date(row.timestamp).toLocaleString() : new Date().toLocaleString()}"`
      ];
      csvRows.push(csvRow.join(","));
    });
    
    // æ·»åŠ æ±‡æ€»è¡Œ
    csvRows.push(""); // ç©ºè¡Œ
    csvRows.push("æ€»è®¡,,,,,,");
    csvRows.push(`åˆè®¡,${totalNTD},${totalCNY},,,,`);
    csvRows.push(`å¹³å‡,${Math.round(totalNTD/data.length)},${Math.round(totalCNY/data.length)},,,,`);
    
    // ç”ŸæˆCSVæ–‡ä»¶
    const csvContent = "\uFEFF" + csvRows.join("\n"); // BOM for Excel
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    
    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const link = document.createElement("a");
    const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, "");
    link.href = url;
    link.download = `å¤ªå²ç¯æ•°æ®_${timestamp}_${data.length}æ¡.csv`;
    link.style.display = "none";
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    URL.revokeObjectURL(url);
    
    setMsg(`âœ… æˆåŠŸå¯¼å‡º ${data.length} æ¡è®°å½•`, "ok");
    
  } catch (error) {
    console.error("å¯¼å‡ºå¤±è´¥:", error);
    setMsg("å¯¼å‡ºå¤±è´¥: " + error.message, "err");
  }
}

// åˆ·æ–°æœ¬åœ°æ•°æ®
function refreshLocalData() {
  const data = readLocalData();
  renderDataTable(data);
  updateStats(data);
  setMsg(`åˆ·æ–°æœ¬åœ°æ•°æ®ï¼Œå…± ${data.length} æ¡è®°å½•`, "ok");
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
function updateStats(data) {
  if (data.length === 0) {
    statsContainer.style.display = "none";
    return;
  }
  
  statsContainer.style.display = "grid";
  
  let totalNTD = 0;
  let totalCNY = 0;
  
  data.forEach(item => {
    totalNTD += item.amountNTD || 0;
    totalCNY += item.amountCNY || 0;
  });
  
  document.getElementById("totalCount").textContent = data.length;
  document.getElementById("totalAmountNTD").textContent = totalNTD.toLocaleString();
  document.getElementById("totalAmountCNY").textContent = totalCNY.toLocaleString();
  
  // è·å–æœ€æ–°è®°å½•çš„æ—¶é—´
  const latestRecord = data.reduce((latest, current) => {
    const currentTime = current.timestamp || 0;
    const latestTime = latest.timestamp || 0;
    return currentTime > latestTime ? current : latest;
  }, { timestamp: 0 });
  
  if (latestRecord.timestamp) {
    const date = new Date(latestRecord.timestamp);
    document.getElementById("lastUpdate").textContent = 
      `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
  } else {
    document.getElementById("lastUpdate").textContent = "åˆšåˆš";
  }
}

// æ¸²æŸ“æ•°æ®è¡¨æ ¼
function renderDataTable(data) {
  dataTableBody.innerHTML = "";
  
  if (!data || data.length === 0) {
    noDataElement.style.display = "block";
    return;
  }
  
  noDataElement.style.display = "none";
  
  data.forEach((row, index) => {
    const tr = document.createElement("tr");
    
    // æ ¼å¼åŒ–æ—¶é—´
    let timeDisplay = "-";
    if (row.timestamp) {
      const date = new Date(row.timestamp);
      timeDisplay = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    }
    
    tr.innerHTML = `
      <td>${index + 1}</td>
      <td><strong>${row.name || ""}</strong></td>
      <td>${ZODIAC_MAP[row.zodiac] || row.zodiac || ""}</td>
      <td style="text-align: right;">${(row.amountNTD || 0).toLocaleString()}</td>
      <td style="text-align: right;">${(row.amountCNY || 0).toLocaleString()}</td>
      <td>${row.contact || ""}</td>
      <td>${timeDisplay}</td>
      <td>
        <button class="btn btn-danger" onclick="deleteRecord(${index})" title="åˆ é™¤">
          åˆ é™¤
        </button>
      </td>
    `;
    dataTableBody.appendChild(tr);
  });
}

// åˆ é™¤è®°å½•
function deleteRecord(index) {
  if (!confirm(`ç¡®å®šè¦åˆ é™¤ç¬¬ ${index + 1} æ¡è®°å½•å—ï¼Ÿ`)) {
    return;
  }
  
  const localData = readLocalData();
  const deletedItem = localData[index];
  
  localData.splice(index, 1);
  
  if (writeLocalData(localData)) {
    renderDataTable(localData);
    updateStats(localData);
    setMsg(`å·²åˆ é™¤è®°å½•: ${deletedItem.name || "æœªçŸ¥"}`, "ok");
  } else {
    setMsg("åˆ é™¤å¤±è´¥", "err");
  }
}

// æµ‹è¯•è¿æ¥
async function testConnection() {
  showLoader(true);
  updateStatus("status-warning", "æ­£åœ¨æµ‹è¯•è¿æ¥...");
  
  try {
    const urlsToTest = [
      { name: "å¥åº·æ£€æŸ¥", url: CONFIG.API_BASE + "/health" },
      { name: "æäº¤API", url: CONFIG.API_BASE + "/submit" }
    ];
    
    let results = [];
    
    for (const test of urlsToTest) {
      try {
        const startTime = Date.now();
        const response = await fetch(test.url, { method: 'GET' });
        const endTime = Date.now();
        const responseTime = endTime - startTime;
        
        results.push({
          name: test.name,
          status: response.status,
          ok: response.ok,
          time: responseTime
        });
      } catch (error) {
        results.push({
          name: test.name,
          status: "ERROR",
          ok: false,
          error: error.message
        });
      }
    }
    
    let message = "è¿æ¥æµ‹è¯•ç»“æœ:\n";
    results.forEach(result => {
      message += `\n${result.name}: ${result.ok ? "âœ… æ­£å¸¸" : "âŒ å¤±è´¥"} ${result.time ? `(${result.time}ms)` : ""} ${result.error || ""}`;
    });
    
    alert(message);
    
    if (results.every(r => r.ok)) {
      updateStatus("status-online", "æ‰€æœ‰è¿æ¥æ­£å¸¸");
    } else {
      updateStatus("status-warning", "éƒ¨åˆ†è¿æ¥å¤±è´¥");
    }
    
  } catch (error) {
    updateStatus("status-offline", "æµ‹è¯•å¤±è´¥");
    alert("æµ‹è¯•å¤±è´¥: " + error.message);
  } finally {
    showLoader(false);
  }
}

// æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
function showDebugInfo() {
  const localData = readLocalData();
  const info = {
    æœ¬åœ°å­˜å‚¨é”®å: CONFIG.STORAGE_KEY,
    è®°å½•æ•°é‡: localData.length,
    APIåœ°å€: CONFIG.API_BASE,
    ç”¨æˆ·ä»£ç†: navigator.userAgent,
    å½“å‰æ—¶é—´: new Date().toISOString(),
    æœ¬åœ°å­˜å‚¨: localStorage.getItem(CONFIG.STORAGE_KEY) ? "å¯ç”¨" : "ç©º"
  };
  
  console.log("è°ƒè¯•ä¿¡æ¯:", info);
  alert("è°ƒè¯•ä¿¡æ¯å·²è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œè¯·æŒ‰F12æŸ¥çœ‹");
}

// åˆå§‹åŒ–
async function init() {
  console.log("ç®¡ç†é¡µé¢åˆå§‹åŒ–...");
  console.log("API Base:", CONFIG.API_BASE);
  console.log("å½“å‰åŸŸå:", window.location.origin);
  
  // æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
  setMsg("ç®¡ç†é¡µé¢å·²åŠ è½½", "info");
  
  // åŠ è½½æœ¬åœ°æ•°æ®
  const localData = readLocalData();
  renderDataTable(localData);
  updateStats(localData);
  
  if (localData.length > 0) {
    setMsg(`å·²åŠ è½½ ${localData.length} æ¡æœ¬åœ°è®°å½•`, "ok");
  }
  
  // è‡ªåŠ¨æµ‹è¯•æ•°æ®åº“è¿æ¥
  setTimeout(async () => {
    try {
      const response = await fetch(CONFIG.API_BASE + "/health");
      if (response.ok) {
        updateStatus("status-online", "æ•°æ®åº“è¿æ¥æ­£å¸¸");
      } else {
        updateStatus("status-offline", "æ•°æ®åº“è¿æ¥å¤±è´¥");
      }
    } catch (error) {
      updateStatus("status-offline", "æ— æ³•è¿æ¥åˆ°æ•°æ®åº“");
    }
  }, 1000);
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener("DOMContentLoaded", init);

// æ·»åŠ é”®ç›˜å¿«æ·é”®
document.addEventListener("keydown", (e) => {
  // Ctrl+R åˆ·æ–°æ•°æ®
  if (e.ctrlKey && e.key === "r") {
    e.preventDefault();
    refreshLocalData();
  }
  
  // Ctrl+E å¯¼å‡ºæ•°æ®
  if (e.ctrlKey && e.key === "e") {
    e.preventDefault();
    exportData();
  }
  
  // Ctrl+S åŒæ­¥åˆ°æ•°æ®åº“
  if (e.ctrlKey && e.key === "s") {
    e.preventDefault();
    syncToDatabase();
  }
});
</script>
</body>
</html>
