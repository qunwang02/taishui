<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>å¤§è‡ªåœ¨å±±æ–°æ˜¥ç¥ˆç¦æ³•ä¼š-å¤ªå²ç¯2026ç®¡ç†é¡µé¢</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: system-ui, -apple-system, "PingFang SC","Microsoft YaHei", Arial;
    background-color: #f5f5f5;
    color: #333;
    line-height: 1.6;
    padding: 15px;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  
  h1 {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 20px;
    font-size: 24px;
  }
  
  .msg {
    margin: 15px 0;
    padding: 12px;
    border-radius: 4px;
    text-align: center;
    font-size: 14px;
  }
  
  .ok {
    color: #0a7d33;
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
  }
  
  .err {
    color: #b80000;
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
  }
  
  .info {
    color: #0c5460;
    background-color: #d1ecf1;
    border: 1px solid #bee5eb;
  }
  
  .warning {
    color: #856404;
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
  }
  
  /* æŒ‰é’®æ ·å¼ */
  .btn {
    padding: 12px 20px;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: bold;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin: 5px;
  }
  
  .btn-primary {
    background-color: #3498db;
    color: white;
  }
  
  .btn-primary:hover {
    background-color: #2980b9;
  }
  
  .btn-success {
    background-color: #2ecc71;
    color: white;
  }
  
  .btn-success:hover {
    background-color: #27ae60;
  }
  
  .btn-danger {
    background-color: #e74c3c;
    color: white;
  }
  
  .btn-danger:hover {
    background-color: #c0392b;
  }
  
  .btn-warning {
    background-color: #f39c12;
    color: white;
  }
  
  .btn-warning:hover {
    background-color: #d68910;
  }
  
  /* è¡¨æ ¼æ ·å¼ */
  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 20px;
    background-color: white;
  }
  
  th, td {
    border: 1px solid #ddd;
    padding: 12px;
    text-align: left;
    font-size: 14px;
  }
  
  th {
    background-color: #f2f2f2;
    font-weight: bold;
    color: #555;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  
  tr:nth-child(even) {
    background-color: #f9f9f9;
  }
  
  tr:hover {
    background-color: #f1f7ff;
  }
  
  /* æŒ‰é’®ç»„ */
  .btn-group {
    margin: 20px 0;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
  }
  
  /* è¿”å›é“¾æ¥ */
  .back-link {
    display: inline-block;
    margin: 10px;
    color: #3498db;
    text-decoration: none;
    font-size: 14px;
  }
  
  .back-link:hover {
    text-decoration: underline;
  }
  
  /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
  .status-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 8px;
  }
  
  .status-online {
    background-color: #2ecc71;
    animation: pulse 2s infinite;
  }
  
  .status-offline {
    background-color: #e74c3c;
  }
  
  .status-warning {
    background-color: #f39c12;
  }
  
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }
  
  /* ç»Ÿè®¡å¡ç‰‡ */
  .stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 15px;
    margin: 20px 0;
  }
  
  .stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }
  
  .stat-card.total {
    background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
  }
  
  .stat-card.amount-ntd {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  }
  
  .stat-card.amount-cny {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  }
  
  .stat-card.updated {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
  }
  
  .stat-card h3 {
    margin: 0 0 10px 0;
    font-size: 14px;
    opacity: 0.9;
  }
  
  .stat-card .value {
    font-size: 28px;
    font-weight: bold;
    margin-bottom: 5px;
  }
  
  .stat-card .subtext {
    font-size: 12px;
    opacity: 0.8;
  }
  
  /* åŠ è½½åŠ¨ç”» */
  .loader {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 40px auto;
  }
  
  /* è¡¨æ ¼å®¹å™¨ */
  .table-container {
    overflow-x: auto;
    margin-top: 20px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    max-height: 600px;
    overflow-y: auto;
  }
  
  /* æ“ä½œæŒ‰é’®ç»„ */
  .action-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  
  /* æœç´¢æ¡† */
  .search-box {
    margin: 20px 0;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 8px;
    display: flex;
    gap: 10px;
  }
  
  .search-box input {
    flex: 1;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
  }
  
  .search-box button {
    padding: 12px 20px;
    background-color: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  
  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .container {
      padding: 15px;
    }
    
    .btn-group {
      flex-direction: column;
    }
    
    .btn {
      width: 100%;
    }
    
    .search-box {
      flex-direction: column;
    }
    
    .action-buttons {
      flex-direction: column;
    }
  }
</style>
</head>
<body>
  <div class="container">
    <h1>å¤§è‡ªåœ¨å±±æ–°æ˜¥ç¥ˆç¦æ³•ä¼š-å¤ªå²ç¯2026ç®¡ç†é¡µé¢</h1>
    
    <!-- çŠ¶æ€æ  -->
    <div id="statusBar" class="msg info">
      <span id="statusIcon" class="status-indicator status-offline"></span>
      <span id="statusText">æ­£åœ¨è¿æ¥æ•°æ®åº“...</span>
      <span id="apiStatus" style="margin-left: 20px;"></span>
    </div>
    
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div id="statsContainer" class="stats-container" style="display: none;">
      <div class="stat-card total">
        <h3>ğŸ“Š æ€»è®°å½•æ•°</h3>
        <div class="value" id="totalCount">0</div>
        <div class="subtext">å…± <span id="databaseCount">0</span> æ¡æ•°æ®åº“è®°å½•</div>
      </div>
      <div class="stat-card amount-ntd">
        <h3>ğŸ’° æŠ¤æŒæ€»é‡‘é¢ (å°å¸)</h3>
        <div class="value" id="totalAmountNTD">0</div>
        <div class="subtext">å¹³å‡: <span id="avgNTD">0</span> å…ƒ/äºº</div>
      </div>
      <div class="stat-card amount-cny">
        <h3>ğŸ’´ æŠ¤æŒæ€»é‡‘é¢ (äººæ°‘å¸)</h3>
        <div class="value" id="totalAmountCNY">0</div>
        <div class="subtext">å¹³å‡: <span id="avgCNY">0</span> å…ƒ/äºº</div>
      </div>
      <div class="stat-card updated">
        <h3>ğŸ•’ æ•°æ®æ›´æ–°æ—¶é—´</h3>
        <div class="value" id="lastUpdate">-</div>
        <div class="subtext" id="dataSource">æ­£åœ¨åŠ è½½...</div>
      </div>
    </div>
    
    <!-- æœç´¢æ¡† -->
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢å§“åã€ç”Ÿè‚–ã€è”ç³»äºº..." 
             oninput="filterTable()" onkeypress="if(event.key==='Enter')filterTable()">
      <button onclick="filterTable()">æœç´¢</button>
      <button onclick="clearSearch()" style="background-color: #95a5a6;">æ¸…é™¤</button>
    </div>
    
    <!-- æ¶ˆæ¯æç¤º -->
    <div id="msg" class="msg"></div>
    
    <!-- æŒ‰é’®ç»„ -->
    <div class="btn-group">
      <button class="btn btn-primary" onclick="loadRealData()">
        <span>ğŸ”„</span> ä»æ•°æ®åº“åŠ è½½çœŸå®æ•°æ®
      </button>
      <button class="btn btn-success" onclick="exportData()">
        <span>ğŸ“Š</span> å¯¼å‡ºä¸ºExcel
      </button>
      <button class="btn btn-warning" onclick="testAllAPIs()">
        <span>ğŸ”§</span> æµ‹è¯•æ‰€æœ‰API
      </button>
      <button class="btn btn-primary" onclick="addTestRecord()">
        <span>â•</span> æ·»åŠ æµ‹è¯•è®°å½•
      </button>
      <button class="btn btn-danger" onclick="forceRefresh()">
        <span>ğŸ’¥</span> å¼ºåˆ¶åˆ·æ–°
      </button>
    </div>
    
    <!-- åŠ è½½åŠ¨ç”» -->
    <div id="loader" class="loader" style="display: none;"></div>
    
    <!-- è¡¨æ ¼å®¹å™¨ -->
    <div class="table-container">
      <table id="dataTable">
        <thead>
          <tr>
            <th>#</th>
            <th>å§“å</th>
            <th>ç”Ÿè‚–</th>
            <th>æŠ¤æŒé‡‘é¢ (å°å¸)</th>
            <th>æŠ¤æŒé‡‘é¢ (äººæ°‘å¸)</th>
            <th>è”ç³»äºº</th>
            <th>æäº¤æ—¶é—´</th>
            <th>Notioné“¾æ¥</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="dataTableBody">
          <tr><td colspan="9" style="text-align: center; padding: 40px;">æ­£åœ¨åŠ è½½çœŸå®æ•°æ®...</td></tr>
        </tbody>
      </table>
    </div>
    
    <!-- æ— æ•°æ®æç¤º -->
    <div id="noData" class="msg warning" style="display: none;">
      <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“­</div>
      <div style="font-size: 18px; margin-bottom: 10px;">æ•°æ®åº“ä¸­æ²¡æœ‰è®°å½•</div>
      <div style="color: #666; margin-bottom: 20px;">æ‚¨å¯ä»¥ç‚¹å‡»"æ·»åŠ æµ‹è¯•è®°å½•"æŒ‰é’®æ¥åˆ›å»ºç¬¬ä¸€æ¡è®°å½•</div>
    </div>
    
    <!-- APIä¿¡æ¯ -->
    <div id="apiInfo" style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; font-size: 12px; color: #666;">
      <div>APIçŠ¶æ€: <span id="healthStatus">æ£€æµ‹ä¸­...</span></div>
      <div>æ•°æ®API: <span id="dataApiStatus">æ£€æµ‹ä¸­...</span></div>
      <div>æœ€åæ£€æµ‹æ—¶é—´: <span id="lastCheckTime">-</span></div>
    </div>
    
    <!-- è¿”å›é“¾æ¥ -->
    <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
      <a href="index.html" class="back-link">â¬…ï¸ è¿”å›ç™»è®°é¡µé¢</a>
      <span style="margin: 0 10px; color: #ddd">|</span>
      <a href="javascript:void(0)" onclick="showSystemInfo()" class="back-link">ğŸ“Š ç³»ç»Ÿä¿¡æ¯</a>
      <span style="margin: 0 10px; color: #ddd">|</span>
      <a href="javascript:void(0)" onclick="showRawData()" class="back-link">ğŸ“‹ æŸ¥çœ‹åŸå§‹æ•°æ®</a>
    </div>
  </div>

<script>
// é…ç½®
const CONFIG = {
  API_BASE: window.location.origin + "/api",
  APP_NAME: "å¤ªå²ç¯2026ç®¡ç†ç³»ç»Ÿ",
  VERSION: "1.0.0"
};

// ç”Ÿè‚–æ˜ å°„
const ZODIAC_MAP = {
  "è‚–é©¬": "ğŸ´ è‚–é©¬ï¼šå€¼å¤ªå²ã€åˆ‘å¤ªå²",
  "è‚–é¼ ": "ğŸ­ è‚–é¼ ï¼šå†²å¤ªå²",
  "è‚–å…”": "ğŸ° è‚–å…”ï¼šç ´å¤ªå²",
  "è‚–ç‰›": "ğŸ® è‚–ç‰›ï¼šå®³å¤ªå²",
  "è‚–é¸¡": "ğŸ” è‚–é¸¡ï¼šå®³å¤ªå²ã€åˆ‘å¤ªå²"
};

// å…¨å±€å˜é‡
let realData = [];
let filteredData = [];
let lastLoadTime = null;

// DOMå…ƒç´ 
const msgElement = document.getElementById("msg");
const statusBar = document.getElementById("statusBar");
const statusIcon = document.getElementById("statusIcon");
const statusText = document.getElementById("statusText");
const dataTableBody = document.getElementById("dataTableBody");
const noDataElement = document.getElementById("noData");
const loader = document.getElementById("loader");
const statsContainer = document.getElementById("statsContainer");
const searchInput = document.getElementById("searchInput");
const healthStatus = document.getElementById("healthStatus");
const dataApiStatus = document.getElementById("dataApiStatus");
const lastCheckTime = document.getElementById("lastCheckTime");

// è®¾ç½®æ¶ˆæ¯
function setMsg(text, type = "", duration = 0) {
  msgElement.className = "msg " + type;
  msgElement.innerHTML = text;
  msgElement.style.display = "block";
  
  if (duration > 0) {
    setTimeout(() => {
      msgElement.style.display = "none";
    }, duration);
  }
}

// æ›´æ–°çŠ¶æ€æ 
function updateStatus(iconClass, text) {
  statusIcon.className = "status-indicator " + iconClass;
  statusText.textContent = text;
}

// æ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
function showLoader(show, text = "åŠ è½½ä¸­...") {
  loader.style.display = show ? "block" : "none";
  if (show) {
    setMsg(text, "info");
  }
}

// å¢å¼ºçš„fetchå‡½æ•°
async function enhancedFetch(url, options = {}) {
  const startTime = Date.now();
  const requestId = Math.random().toString(36).substring(7);
  
  console.log(`ğŸš€ [${requestId}] ${options.method || 'GET'} ${url}`);
  
  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ç§’è¶…æ—¶
    
    const response = await fetch(url, {
      ...options,
      signal: controller.signal,
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      }
    });
    
    clearTimeout(timeoutId);
    
    const endTime = Date.now();
    const duration = endTime - startTime;
    
    let data;
    try {
      data = await response.json();
    } catch (e) {
      data = { raw: await response.text() };
    }
    
    console.log(`âœ… [${requestId}] ${response.status} (${duration}ms)`, data);
    
    return {
      ok: response.ok,
      status: response.status,
      data: data,
      duration: duration
    };
    
  } catch (error) {
    const endTime = Date.now();
    const duration = endTime - startTime;
    
    console.error(`âŒ [${requestId}] è¯·æ±‚å¤±è´¥ (${duration}ms):`, error);
    
    return {
      ok: false,
      error: error.message,
      duration: duration
    };
  }
}

// ä»æ•°æ®åº“åŠ è½½çœŸå®æ•°æ®
async function loadRealData() {
  showLoader(true, "æ­£åœ¨ä»Notionæ•°æ®åº“åŠ è½½çœŸå®æ•°æ®...");
  updateStatus("status-warning", "æ­£åœ¨åŠ è½½æ•°æ®...");
  
  try {
    const result = await enhancedFetch(CONFIG.API_BASE + "/data");
    
    if (result.ok && result.data.ok) {
      // ä¿å­˜çœŸå®æ•°æ®
      realData = result.data.data || [];
      filteredData = [...realData];
      
      lastLoadTime = new Date();
      
      // æ¸²æŸ“è¡¨æ ¼
      renderDataTable(realData);
      
      // æ›´æ–°ç»Ÿè®¡
      updateStats(result.data);
      
      // æ›´æ–°çŠ¶æ€
      updateStatus("status-online", `å·²åŠ è½½ ${realData.length} æ¡çœŸå®è®°å½•`);
      setMsg(`âœ… æˆåŠŸä»Notionæ•°æ®åº“åŠ è½½ ${realData.length} æ¡è®°å½•`, "ok", 3000);
      
      // æ›´æ–°APIçŠ¶æ€
      healthStatus.innerHTML = '<span style="color:#2ecc71">âœ… æ­£å¸¸</span>';
      dataApiStatus.innerHTML = '<span style="color:#2ecc71">âœ… æ­£å¸¸ (' + realData.length + 'æ¡)</span>';
      lastCheckTime.textContent = new Date().toLocaleTimeString('zh-CN');
      
    } else {
      const errorMsg = result.data?.error || "æœªçŸ¥é”™è¯¯";
      console.error("åŠ è½½æ•°æ®å¤±è´¥:", result);
      
      updateStatus("status-offline", "åŠ è½½æ•°æ®å¤±è´¥");
      setMsg(`âŒ åŠ è½½æ•°æ®å¤±è´¥: ${errorMsg}`, "err");
      
      healthStatus.innerHTML = result.status === 200 ? 
        '<span style="color:#f39c12">âš ï¸ æ•°æ®å¼‚å¸¸</span>' : 
        '<span style="color:#e74c3c">âŒ å¤±è´¥</span>';
      dataApiStatus.innerHTML = '<span style="color:#e74c3c">âŒ å¤±è´¥</span>';
    }
    
  } catch (error) {
    console.error("åŠ è½½æ•°æ®å¼‚å¸¸:", error);
    updateStatus("status-offline", "ç½‘ç»œé”™è¯¯");
    setMsg("âŒ ç½‘ç»œè¿æ¥é”™è¯¯: " + error.message, "err");
    
    healthStatus.innerHTML = '<span style="color:#e74c3c">âŒ è¿æ¥å¤±è´¥</span>';
    dataApiStatus.innerHTML = '<span style="color:#e74c3c">âŒ è¿æ¥å¤±è´¥</span>';
    
  } finally {
    showLoader(false);
    
    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºæç¤º
    if (realData.length === 0) {
      noDataElement.style.display = "block";
      statsContainer.style.display = "none";
    } else {
      noDataElement.style.display = "none";
      statsContainer.style.display = "grid";
    }
  }
}

// æµ‹è¯•æ‰€æœ‰API
async function testAllAPIs() {
  showLoader(true, "æ­£åœ¨æµ‹è¯•æ‰€æœ‰APIè¿æ¥...");
  
  try {
    const tests = [
      { name: "å¥åº·æ£€æŸ¥", url: "/health", method: "GET" },
      { name: "æ•°æ®API", url: "/data", method: "GET" },
      { name: "æäº¤API", url: "/submit", method: "POST" }
    ];
    
    let results = [];
    let allOk = true;
    
    for (const test of tests) {
      if (test.method === "POST") {
        // æµ‹è¯•æäº¤API
        const testData = {
          title: `æµ‹è¯•ç”¨æˆ·_${Date.now()}`,
          zodiac: "è‚–é©¬",
          "æŠ¤æŒé‡‘é¢å°å¸": 1200,
          äººæ°‘å¸: 286,
          è”ç³»äºº: "APIæµ‹è¯•"
        };
        
        const result = await enhancedFetch(CONFIG.API_BASE + test.url, {
          method: "POST",
          body: JSON.stringify(testData)
        });
        
        results.push({
          name: test.name,
          ok: result.ok,
          status: result.status,
          time: result.duration,
          data: result.data
        });
        
        if (!result.ok) allOk = false;
        
      } else {
        const result = await enhancedFetch(CONFIG.API_BASE + test.url);
        
        results.push({
          name: test.name,
          ok: result.ok,
          status: result.status,
          time: result.duration,
          data: result.data
        });
        
        if (!result.ok) allOk = false;
      }
    }
    
    // æ˜¾ç¤ºç»“æœ
    let message = `<strong>APIè¿æ¥æµ‹è¯•ç»“æœ:</strong><br><br>`;
    results.forEach(result => {
      if (result.ok) {
        message += `âœ… <strong>${result.name}</strong>: æ­£å¸¸ (${result.time}ms)<br>`;
        if (result.data && result.data.error) {
          message += `&nbsp;&nbsp;&nbsp;&nbsp;âš ï¸ ${result.data.error}<br>`;
        }
      } else {
        message += `âŒ <strong>${result.name}</strong>: å¤±è´¥<br>`;
        if (result.data && result.data.error) {
          message += `&nbsp;&nbsp;&nbsp;&nbsp;${result.data.error}<br>`;
        } else if (result.error) {
          message += `&nbsp;&nbsp;&nbsp;&nbsp;${result.error}<br>`;
        } else {
          message += `&nbsp;&nbsp;&nbsp;&nbsp;HTTP ${result.status}<br>`;
        }
      }
      message += "<br>";
    });
    
    if (allOk) {
      message += `<span style="color:#2ecc71">ğŸ‰ æ‰€æœ‰APIå·¥ä½œæ­£å¸¸ï¼</span>`;
      updateStatus("status-online", "æ‰€æœ‰APIæ­£å¸¸");
    } else {
      message += `<span style="color:#e74c3c">âš ï¸ éƒ¨åˆ†APIå­˜åœ¨é—®é¢˜</span>`;
      updateStatus("status-warning", "APIæµ‹è¯•å‘ç°é—®é¢˜");
    }
    
    setMsg(message, allOk ? "ok" : "err");
    
  } catch (error) {
    setMsg("æµ‹è¯•è¿‡ç¨‹å‡ºé”™: " + error.message, "err");
  } finally {
    showLoader(false);
  }
}

// æ·»åŠ æµ‹è¯•è®°å½•
async function addTestRecord() {
  const name = prompt("è¯·è¾“å…¥æµ‹è¯•å§“å:", "æµ‹è¯•ç”¨æˆ·_" + Date.now().toString().slice(-6));
  if (!name) return;
  
  const zodiacOptions = ["è‚–é©¬", "è‚–é¼ ", "è‚–å…”", "è‚–ç‰›", "è‚–é¸¡"];
  const zodiac = prompt("è¯·é€‰æ‹©ç”Ÿè‚–:\n1. è‚–é©¬\n2. è‚–é¼ \n3. è‚–å…”\n4. è‚–ç‰›\n5. è‚–é¸¡", "è‚–é©¬");
  if (!zodiac || !zodiacOptions.includes(zodiac)) {
    setMsg("âŒ ç”Ÿè‚–é€‰æ‹©æ— æ•ˆ", "err");
    return;
  }
  
  const amountStr = prompt("è¯·è¾“å…¥æŠ¤æŒé‡‘é¢ï¼ˆå°å¸ï¼‰:", "1200");
  const amountNTD = parseInt(amountStr) || 1200;
  const amountCNY = Math.round(amountNTD / 4.2);
  
  const contact = prompt("è¯·è¾“å…¥è”ç³»äºº:", "æµ‹è¯•è”ç³»äºº");
  if (!contact) return;
  
  showLoader(true, "æ­£åœ¨æäº¤æµ‹è¯•è®°å½•åˆ°Notion...");
  
  try {
    const testData = {
      title: name,
      zodiac: zodiac,
      "æŠ¤æŒé‡‘é¢å°å¸": amountNTD,
      äººæ°‘å¸: amountCNY,
      è”ç³»äºº: contact
    };
    
    console.log("æäº¤æµ‹è¯•è®°å½•:", testData);
    
    const result = await enhancedFetch(CONFIG.API_BASE + "/submit", {
      method: "POST",
      body: JSON.stringify(testData)
    });
    
    if (result.ok && (result.data.ok || result.data.pageId)) {
      setMsg(`âœ… æµ‹è¯•è®°å½•å·²æˆåŠŸæäº¤åˆ°Notionï¼é¡µé¢ID: ${result.data.pageId || "N/A"}`, "ok");
      
      // å»¶è¿Ÿååˆ·æ–°æ•°æ®
      setTimeout(() => {
        loadRealData();
      }, 1500);
      
    } else {
      const errorMsg = result.data?.error || result.error || `HTTP ${result.status}`;
      setMsg(`âŒ æäº¤å¤±è´¥: ${errorMsg}`, "err");
      
      // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
      if (errorMsg.includes("ç¼ºå°‘åˆ—") || errorMsg.includes("ç±»å‹ä¸åŒ¹é…")) {
        setMsg(`æ•°æ®åº“å­—æ®µé—®é¢˜: ${errorMsg}<br>è¯·æ£€æŸ¥æ•°æ®åº“ç»“æ„æ˜¯å¦ä¸æäº¤æ•°æ®åŒ¹é…`, "err");
      }
    }
  } catch (error) {
    setMsg("æäº¤å¼‚å¸¸: " + error.message, "err");
  } finally {
    showLoader(false);
  }
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
function updateStats(data) {
  if (!data || !data.data || data.data.length === 0) {
    statsContainer.style.display = "none";
    return;
  }
  
  statsContainer.style.display = "grid";
  
  const records = data.data;
  const stats = data.stats || {
    total: records.length,
    totalNTD: records.reduce((sum, r) => sum + (r.amountNTD || 0), 0),
    totalCNY: records.reduce((sum, r) => sum + (r.amountCNY || 0), 0)
  };
  
  // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
  document.getElementById("totalCount").textContent = stats.total;
  document.getElementById("databaseCount").textContent = stats.total;
  document.getElementById("totalAmountNTD").textContent = stats.totalNTD.toLocaleString();
  document.getElementById("totalAmountCNY").textContent = stats.totalCNY.toLocaleString();
  
  // è®¡ç®—å¹³å‡å€¼
  const avgNTD = stats.total > 0 ? Math.round(stats.totalNTD / stats.total) : 0;
  const avgCNY = stats.total > 0 ? Math.round(stats.totalCNY / stats.total) : 0;
  
  document.getElementById("avgNTD").textContent = avgNTD.toLocaleString();
  document.getElementById("avgCNY").textContent = avgCNY.toLocaleString();
  
  // æ›´æ–°æ—¶é—´
  const now = new Date();
  document.getElementById("lastUpdate").textContent = 
    `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
  
  document.getElementById("dataSource").textContent = `æ¥è‡ªNotionæ•°æ®åº“ â€¢ ${stats.total}æ¡è®°å½•`;
}

// æ¸²æŸ“æ•°æ®è¡¨æ ¼
function renderDataTable(data) {
  dataTableBody.innerHTML = "";
  
  if (!data || data.length === 0) {
    noDataElement.style.display = "block";
    return;
  }
  
  noDataElement.style.display = "none";
  
  data.forEach((row, index) => {
    const tr = document.createElement("tr");
    
    // æ ¼å¼åŒ–æ—¶é—´
    let timeDisplay = "-";
    if (row.created_time) {
      const date = new Date(row.created_time);
      timeDisplay = `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}<br>${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    }
    
    // Notioné“¾æ¥
    const notionLink = row.url ? 
      `<a href="${row.url}" target="_blank" title="åœ¨Notionä¸­æŸ¥çœ‹" style="color: #3498db; text-decoration: none;">ğŸ”—</a>` : 
      "ğŸ”—";
    
    tr.innerHTML = `
      <td><strong>${index + 1}</strong></td>
      <td><strong>${row.name || ""}</strong></td>
      <td>${ZODIAC_MAP[row.zodiac] || row.zodiac || ""}</td>
      <td style="text-align: right; color: #e74c3c; font-weight: bold;">${(row.amountNTD || 0).toLocaleString()}</td>
      <td style="text-align: right; color: #2ecc71; font-weight: bold;">${(row.amountCNY || 0).toLocaleString()}</td>
      <td>${row.contact || ""}</td>
      <td style="font-size: 12px;">${timeDisplay}</td>
      <td style="text-align: center;">${notionLink}</td>
      <td class="action-buttons">
        <button class="btn btn-danger" onclick="viewInNotion('${row.id}')" title="åœ¨Notionä¸­æŸ¥çœ‹">
          æŸ¥çœ‹
        </button>
      </td>
    `;
    dataTableBody.appendChild(tr);
  });
}

// åœ¨Notionä¸­æŸ¥çœ‹
function viewInNotion(id) {
  window.open(`https://notion.so/${id.replace(/-/g, '')}`, '_blank');
}

// è¿‡æ»¤è¡¨æ ¼
function filterTable() {
  const searchTerm = searchInput.value.toLowerCase().trim();
  
  if (!searchTerm) {
    filteredData = [...realData];
    renderDataTable(filteredData);
    setMsg(`æ˜¾ç¤ºå…¨éƒ¨ ${realData.length} æ¡è®°å½•`, "info", 2000);
    return;
  }
  
  filteredData = realData.filter(row => {
    return (
      (row.name && row.name.toLowerCase().includes(searchTerm)) ||
      (row.zodiac && row.zodiac.toLowerCase().includes(searchTerm)) ||
      (row.contact && row.contact.toLowerCase().includes(searchTerm)) ||
      (row.amountNTD && row.amountNTD.toString().includes(searchTerm)) ||
      (row.amountCNY && row.amountCNY.toString().includes(searchTerm))
    );
  });
  
  renderDataTable(filteredData);
  setMsg(`æ‰¾åˆ° ${filteredData.length} æ¡åŒ¹é…è®°å½•`, filteredData.length > 0 ? "ok" : "warning", 3000);
}

// æ¸…é™¤æœç´¢
function clearSearch() {
  searchInput.value = "";
  filterTable();
}

// å¯¼å‡ºæ•°æ®
function exportData() {
  if (realData.length === 0) {
    setMsg("æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡º", "warning");
    return;
  }
  
  try {
    // å‡†å¤‡CSVæ•°æ®
    const headers = ["åºå·", "å§“å", "ç”Ÿè‚–", "æŠ¤æŒé‡‘é¢å°å¸", "äººæ°‘å¸", "è”ç³»äºº", "æäº¤æ—¶é—´", "Notioné“¾æ¥"];
    const csvRows = [headers.join(",")];
    
    realData.forEach((row, index) => {
      const timeStr = row.created_time ? new Date(row.created_time).toLocaleString('zh-CN') : "-";
      const notionUrl = row.url || `https://notion.so/${row.id.replace(/-/g, '')}`;
      
      const csvRow = [
        index + 1,
        `"${row.name || ""}"`,
        `"${row.zodiac || ""}"`,
        row.amountNTD || 0,
        row.amountCNY || 0,
        `"${row.contact || ""}"`,
        `"${timeStr}"`,
        `"${notionUrl}"`
      ];
      csvRows.push(csvRow.join(","));
    });
    
    // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
    const totalNTD = realData.reduce((sum, r) => sum + (r.amountNTD || 0), 0);
    const totalCNY = realData.reduce((sum, r) => sum + (r.amountCNY || 0), 0);
    
    csvRows.push("");
    csvRows.push("ç»Ÿè®¡ä¿¡æ¯,,,,,,,");
    csvRows.push(`æ€»è®°å½•æ•°,${realData.length},,,,,,`);
    csvRows.push(`å°å¸æ€»é¢,${totalNTD},,,,,,`);
    csvRows.push(`äººæ°‘å¸æ€»é¢,${totalCNY},,,,,,`);
    csvRows.push(`å¹³å‡å°å¸,${Math.round(totalNTD/realData.length)},,,,,,`);
    csvRows.push(`å¹³å‡äººæ°‘å¸,${Math.round(totalCNY/realData.length)},,,,,,`);
    csvRows.push(`å¯¼å‡ºæ—¶é—´,"${new Date().toLocaleString('zh-CN')}",,,,,,`);
    
    // ç”ŸæˆCSVæ–‡ä»¶
    const csvContent = "\uFEFF" + csvRows.join("\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    
    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const link = document.createElement("a");
    const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, "");
    link.href = url;
    link.download = `å¤ªå²ç¯çœŸå®æ•°æ®_${timestamp}_${realData.length}æ¡.csv`;
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    URL.revokeObjectURL(url);
    
    setMsg(`âœ… æˆåŠŸå¯¼å‡º ${realData.length} æ¡çœŸå®è®°å½•`, "ok", 3000);
    
  } catch (error) {
    console.error("å¯¼å‡ºå¤±è´¥:", error);
    setMsg("å¯¼å‡ºå¤±è´¥: " + error.message, "err");
  }
}

// å¼ºåˆ¶åˆ·æ–°
function forceRefresh() {
  if (confirm("å¼ºåˆ¶åˆ·æ–°å°†æ¸…é™¤æ‰€æœ‰ç¼“å­˜æ•°æ®å¹¶é‡æ–°ä»æ•°æ®åº“åŠ è½½ã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ")) {
    realData = [];
    filteredData = [];
    loadRealData();
  }
}

// æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
function showSystemInfo() {
  const info = {
    "åº”ç”¨åç§°": CONFIG.APP_NAME,
    "ç‰ˆæœ¬": CONFIG.VERSION,
    "APIåœ°å€": CONFIG.API_BASE,
    "æ•°æ®åº“è®°å½•æ•°": realData.length,
    "æœ€ååŠ è½½æ—¶é—´": lastLoadTime ? lastLoadTime.toLocaleString('zh-CN') : "æœªåŠ è½½",
    "ç”¨æˆ·ä»£ç†": navigator.userAgent.substring(0, 50) + "...",
    "å½“å‰æ—¶é—´": new Date().toLocaleString('zh-CN')
  };
  
  let message = "<strong>ç³»ç»Ÿä¿¡æ¯</strong><br><br>";
  for (const [key, value] of Object.entries(info)) {
    message += `<strong>${key}:</strong> ${value}<br>`;
  }
  
  setMsg(message, "info");
}

// æ˜¾ç¤ºåŸå§‹æ•°æ®
function showRawData() {
  if (realData.length === 0) {
    setMsg("æš‚æ— æ•°æ®å¯æ˜¾ç¤º", "warning");
    return;
  }
  
  console.log("åŸå§‹æ•°æ®:", realData);
  alert(`åŸå§‹æ•°æ®å·²è¾“å‡ºåˆ°æ§åˆ¶å° (æŒ‰F12æŸ¥çœ‹)\n\nè®°å½•æ•°: ${realData.length}\n\nè¯·åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­æŸ¥çœ‹è¯¦ç»†æ•°æ®ã€‚`);
}

// åˆå§‹åŒ–
async function init() {
  console.log("ğŸš€ å¤ªå²ç¯2026ç®¡ç†ç³»ç»Ÿå¯åŠ¨");
  console.log("ğŸ“¡ APIåœ°å€:", CONFIG.API_BASE);
  console.log("ğŸ•’ å¯åŠ¨æ—¶é—´:", new Date().toLocaleString('zh-CN'));
  
  setMsg("ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–...", "info");
  
  // è‡ªåŠ¨æ£€æŸ¥APIçŠ¶æ€
  setTimeout(async () => {
    try {
      const result = await enhancedFetch(CONFIG.API_BASE + "/health");
      if (result.ok && result.data.ok) {
        updateStatus("status-online", "æ•°æ®åº“è¿æ¥æ­£å¸¸");
        healthStatus.innerHTML = '<span style="color:#2ecc71">âœ… æ­£å¸¸</span>';
        
        // è‡ªåŠ¨åŠ è½½æ•°æ®
        loadRealData();
      } else {
        updateStatus("status-offline", "æ•°æ®åº“è¿æ¥å¤±è´¥");
        healthStatus.innerHTML = '<span style="color:#e74c3c">âŒ å¤±è´¥</span>';
        setMsg("æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®", "err");
      }
    } catch (error) {
      updateStatus("status-offline", "è¿æ¥é”™è¯¯");
      healthStatus.innerHTML = '<span style="color:#e74c3c">âŒ è¿æ¥é”™è¯¯</span>';
    }
    
    lastCheckTime.textContent = new Date().toLocaleTimeString('zh-CN');
  }, 1000);
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener("DOMContentLoaded", init);

// é”®ç›˜å¿«æ·é”®
document.addEventListener("keydown", (e) => {
  // Ctrl+R åˆ·æ–°æ•°æ®
  if (e.ctrlKey && e.key === "r") {
    e.preventDefault();
    loadRealData();
  }
  
  // Ctrl+F èšç„¦æœç´¢æ¡†
  if (e.ctrlKey && e.key === "f") {
    e.preventDefault();
    searchInput.focus();
  }
  
  // F5 å¼ºåˆ¶åˆ·æ–°
  if (e.key === "F5") {
    e.preventDefault();
    forceRefresh();
  }
});
</script>
</body>
</html>
